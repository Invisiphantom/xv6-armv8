<!DOCTYPE html><html><head>
      <title>lab 7</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({"extensions":["tex2jax.js"],"jax":["input/TeX","output/HTML-CSS"],"messageStyle":"none","tex2jax":{"processEnvironments":false,"processEscapes":true,"inlineMath":[["$","$"],["\\(","\\)"]],"displayMath":[["$$","$$"],["\\[","\\]"]]},"TeX":{"extensions":["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]},"HTML-CSS":{"availableFonts":["TeX"]}});
        </script>
        <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
        
      
      
      
      
      
      
      
      
      
      <style>
      pre{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;padding:1em;margin:.5em 0;overflow:auto;line-height:1.5;tab-size:4;hyphens:none;color:#c5c8c6;background-color:#27292c !important;border:#43484c;border-radius:3px}pre[class*="language-"]{padding:1em}code[class*="language-"] .token.comment,pre[class*="language-"] .token.comment,code[class*="language-"] .token.prolog,pre[class*="language-"] .token.prolog,code[class*="language-"] .token.doctype,pre[class*="language-"] .token.doctype,code[class*="language-"] .token.cdata,pre[class*="language-"] .token.cdata{color:#7C7C7C}code[class*="language-"] .token.punctuation,pre[class*="language-"] .token.punctuation{color:#96CBFE}code[class*="language-"] .namespace,pre[class*="language-"] .namespace{opacity:.7}code[class*="language-"] .token.constant,pre[class*="language-"] .token.constant{color:#99CC99}code[class*="language-"] .token.boolean,pre[class*="language-"] .token.boolean,code[class*="language-"] .token.number,pre[class*="language-"] .token.number,code[class*="language-"] .token.function-name,pre[class*="language-"] .token.function-name{color:#FF73FD}code[class*="language-"] .token.tag,pre[class*="language-"] .token.tag{color:#96CBFE}code[class*="language-"] .token.selector,pre[class*="language-"] .token.selector{color:#96CBFE}code[class*="language-"] .token.attr-name,pre[class*="language-"] .token.attr-name{color:#C6C5FE}code[class*="language-"] .token.string,pre[class*="language-"] .token.string{color:#A8FF60}code[class*="language-"] .token.char,pre[class*="language-"] .token.char{color:#FF8000}code[class*="language-"] .token.entity,pre[class*="language-"] .token.entity{color:#FFD2A7}code[class*="language-"] .token.url,pre[class*="language-"] .token.url{color:#7C7C7C}code[class*="language-"] .token.operator,pre[class*="language-"] .token.operator{color:#EDEDED}code[class*="language-"] .token.atrule,pre[class*="language-"] .token.atrule,code[class*="language-"] .token.attr-value,pre[class*="language-"] .token.attr-value,code[class*="language-"] .token.keyword,pre[class*="language-"] .token.keyword{color:#CFCB90}code[class*="language-"] .token.function,pre[class*="language-"] .token.function{color:#FFD2A7}code[class*="language-"] .token.class-name,pre[class*="language-"] .token.class-name{color:#FFD2A7}code[class*="language-"] .token.variable,pre[class*="language-"] .token.variable{color:#C6C5FE}code[class*="language-"] .token.regex,pre[class*="language-"] .token.regex,code[class*="language-"] .token.important,pre[class*="language-"] .token.important{color:#E9C062}code[class*="language-"] .token.important,pre[class*="language-"] .token.important,code[class*="language-"] .token.bold,pre[class*="language-"] .token.bold{font-weight:bold}code[class*="language-"] .token.italic,pre[class*="language-"] .token.italic{font-style:italic}code[class*="language-"] .token.entity,pre[class*="language-"] .token.entity{cursor:help}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:rgba(153,122,102,0.08);background:linear-gradient(to right, rgba(153,122,102,0.1) 70%, rgba(153,122,102,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:rgba(153,122,102,0.4);color:#f5f2f0;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px white}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
.markdown-preview.markdown-preview {
  font-family: "Sarasa Gothic SC", sans-serif;
}
.markdown-preview.markdown-preview pre {
  font-family: "Sarasa Mono SC", sans-serif;
  max-height: calc(100vh - 250px);
}
.markdown-preview.markdown-preview pre > code {
  font-family: "Sarasa Mono SC", sans-serif;
  color: #C5C8C6;
  font-size: 1em !important;
}

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <h1 class="mume-header" id="lab-7-file-system-and-shell">Lab 7: File System and Shell</h1>

<h2 class="mume-header" id="%E4%B9%A0%E9%A2%98%E8%A7%A3%E7%AD%94">&#x4E60;&#x9898;&#x89E3;&#x7B54;</h2>

<h3 class="mume-header" id="1-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F">1. &#x6587;&#x4EF6;&#x7CFB;&#x7EDF;</h3>

<blockquote>
<p>&#x8BF7;&#x5B9E;&#x73B0;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#xFF0C;&#x672C;&#x5B9E;&#x9A8C;&#x4E2D;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x9075;&#x5FAA; xv6 &#x7684;&#x8BBE;&#x8BA1;&#xFF0C;&#x4F60;&#x4E5F;&#x53EF;&#x4EE5;&#x4ECE; 0 &#x5F00;&#x59CB;&#x8BBE;&#x8BA1;&#x5C5E;&#x4E8E;&#x4F60;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x3002;&#x5982;&#x679C;&#x4F60;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E0D;&#x540C;&#x4E8E; xv6 &#x7684;&#x8BDD;&#xFF0C;&#x8BF7;&#x4FEE;&#x6539; <code>user/src/mkfs</code>&#x3002;&#x4F60;&#x9700;&#x8981;&#x6DFB;&#x52A0;&#x6D4B;&#x8BD5;&#x8BC1;&#x660E;&#x4F60;&#x5B9E;&#x73B0;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x53EF;&#x4EE5;&#x8BFB;&#x53D6;&#x5230;&#x4F60;&#x6253;&#x5305;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x5728;&#x6570;&#x91CF;&#x3001;&#x5185;&#x5BB9;&#x4E0A;&#x662F;&#x6B63;&#x786E;&#x7684;&#x3002;</p>
</blockquote>
<h4 class="mume-header" id="10-%E6%80%BB%E8%A7%88">1.0 &#x603B;&#x89C8;</h4>

<p><img src="./assets/file_system.png" alt="Layers of the xv6 file system"></p>
<p>&#x672C;&#x56FE;&#x5F15;&#x81EA; <em>xv6: a simple, Unix-like teaching operating system</em> <sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>&#x3002;</p>
<p>&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684;&#x603B;&#x4F53;&#x7ED3;&#x6784;&#x53C2;&#x8003; Xv6 <sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup> &#x7684;&#x8BBE;&#x8BA1;&#xFF0C;&#x5176; 7 &#x5C42;&#x7ED3;&#x6784;&#x5982;&#x56FE;&#x6240;&#x793A;&#x3002;&#x4EE5;&#x4E0B;&#x6211;&#x4EEC;&#x5C06;&#x81EA;&#x5E95;&#x5411;&#x4E0A;&#x4F9D;&#x6B21;&#x8FDB;&#x884C;&#x9610;&#x8FF0;&#x3002;</p>
<h4 class="mume-header" id="11-disk">1.1 Disk</h4>

<p>&#x7B2C; 1 &#x5C42;&#x662F;&#x78C1;&#x76D8;&#x9A71;&#x52A8;&#xFF0C;&#x4F5C;&#x4E3A;&#x7269;&#x7406;&#x78C1;&#x76D8;&#x7684;&#x62BD;&#x8C61;&#x5C42;&#xFF0C;&#x4E3A;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x63D0;&#x4F9B;&#x4E86;&#x8BFB;&#x5199;&#x78C1;&#x76D8;&#x5757;&#x7684;&#x65B9;&#x6CD5;&#x3002;&#x6211;&#x4EEC;&#x5DF2;&#x5728; Lab 6 &#x65F6;&#x5728; <code>kern/sd.c</code> &#x4E2D;&#x5B9E;&#x73B0;&#xFF0C;&#x8BE6;&#x89C1; Lab 6 &#x7B2C; 2 &#x8282;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E00;&#x5C42;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x4E86;&#x4EE5;&#x4E0B;&#x65B9;&#x6CD5;&#xFF1A;</p>
<ul>
<li><code>sd_init</code>&#xFF1A;&#x521D;&#x59CB;&#x5316; SD &#x5361;&#x5E76;&#x89E3;&#x6790;&#x4E3B;&#x5F15;&#x5BFC;&#x8BB0;&#x5F55;</li>
<li><code>sd_intr</code>&#xFF1A;&#x5904;&#x7406; SD &#x5361;&#x8BBE;&#x5907;&#x4E2D;&#x65AD;</li>
<li><code>sd_rw</code>&#xFF1A;&#x8BFB;&#x5199; SD &#x5361;&#x78C1;&#x76D8;&#x5757;</li>
</ul>
<h4 class="mume-header" id="12-buffer-cache">1.2 Buffer cache</h4>

<p>&#x7B2C; 2 &#x5C42;&#x662F;&#x78C1;&#x76D8;&#x5757;&#x7F13;&#x5B58;&#xFF0C;&#x7528;&#x4E8E;&#x5C06;&#x78C1;&#x76D8;&#x5757;&#x7F13;&#x5B58;&#x5230;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x4ECE;&#x800C;&#x52A0;&#x5FEB;&#x78C1;&#x76D8;&#x8BFB;&#x5199;&#x3002;&#x6211;&#x4EEC;&#x5DF2;&#x5728; Lab 6 &#x65F6;&#x5728; <code>kern/bio.c</code> &#x4E2D;&#x5B9E;&#x73B0;&#xFF0C;&#x8BE6;&#x89C1; Lab 6 &#x7B2C; 1 &#x8282;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E00;&#x5C42;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x4E86;&#x4EE5;&#x4E0B;&#x65B9;&#x6CD5;&#xFF1A;</p>
<ul>
<li><code>binit</code>&#xFF1A;&#x521D;&#x59CB;&#x5316; <code>buf</code> &#x961F;&#x5217; <code>bcache</code></li>
<li><code>bread</code>&#xFF1A;&#x4ECE;&#x78C1;&#x76D8;&#x8BFB;&#x53D6; <code>buf</code> &#x5230;&#x5185;&#x5B58;</li>
<li><code>bwrite</code>&#xFF1A;&#x5C06; <code>buf</code> &#x4ECE;&#x5185;&#x5B58;&#x5199;&#x5165;&#x78C1;&#x76D8;</li>
<li><code>brelse</code>&#xFF1A;&#x91CA;&#x653E;&#x4E00;&#x4E2A;&#x4E0D;&#x5728;&#x4F7F;&#x7528;&#x4E2D;&#x7684; <code>buf</code></li>
<li><code>bpin</code>&#xFF1A;&#x5C06; <code>buf</code> &#x7684;&#x5F15;&#x7528;&#x6570;&#xFF08;<code>refcnt</code>&#xFF09;&#x52A0; <code>1</code>&#xFF0C;&#x5176;&#x4E2D;&#x5F15;&#x7528;&#x6570;&#x8868;&#x793A;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x7B49;&#x5F85;&#x6B64; <code>buf</code> &#x7684;&#x8BBE;&#x5907;&#x6570;&#x91CF;</li>
<li><code>bunpin</code>&#xFF1A;&#x5C06; <code>buf</code> &#x7684;&#x5F15;&#x7528;&#x6570;&#xFF08;<code>refcnt</code>&#xFF09;&#x51CF; <code>1</code></li>
</ul>
<h4 class="mume-header" id="13-logging">1.3 Logging</h4>

<p>&#x7B2C; 3 &#x5C42;&#x662F;&#x78C1;&#x76D8;&#x6539;&#x52A8;&#x65E5;&#x5FD7;&#xFF0C;&#x7528;&#x4E8E;&#x7EF4;&#x62A4;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684;&#x5D29;&#x6E83;&#x4E00;&#x81F4;&#x6027;&#xFF08;crash consistency&#xFF09;&#xFF0C;&#x786E;&#x4FDD;&#x5199;&#x78C1;&#x76D8;&#x7684;&#x4E8B;&#x52A1;&#x662F;&#x539F;&#x5B50;&#xFF08;atomic&#xFF09;&#x7684;&#x3002;&#x6211;&#x4EEC;&#x5C06;&#x5728; <code>kern/log.c</code> &#x4E2D;&#x5B9E;&#x73B0;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E00;&#x5C42;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x4E86;&#x4EE5;&#x4E0B;&#x65B9;&#x6CD5;&#xFF1A;</p>
<ul>
<li><code>initlog</code>&#xFF1A;&#x521D;&#x59CB;&#x5316; <code>log</code></li>
<li><code>log_write</code>&#xFF1A;&#x4F5C;&#x4E3A; <code>bwrite</code> &#x7684;&#x4EE3;&#x7406;&#xFF0C;&#x5728; <code>log</code> &#x4E2D;&#x8BB0;&#x5F55;&#x9700;&#x8981;&#x88AB;&#x5199;&#x5165;&#x78C1;&#x76D8;&#x7684; block &#x7684;&#x6807;&#x53F7;&#xFF0C;&#x5E76;&#x6807;&#x8BB0;&#x4E3A; dirty&#xFF0C;&#x4E4B;&#x540E;&#x7EDF;&#x4E00;&#x5199;&#x5165;</li>
<li><code>begin_op</code>&#xFF1A;&#x5F00;&#x59CB;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</li>
<li><code>end_op</code>&#xFF1A;&#x7ED3;&#x675F;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</li>
</ul>
<h5 class="mume-header" id="131-initlog">1.3.1 <code>initlog</code></h5>

<p>&#x51FD;&#x6570; <code>initlog</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x6839;&#x636E; super block &#x4E2D;&#x7684;&#x4FE1;&#x606F;&#x5BF9; <code>log</code> &#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>recover_from_log</code>&#xFF0C;&#x6839;&#x636E; log header &#x6062;&#x590D;&#x5D29;&#x6E83;&#x524D;&#x672A;&#x5199;&#x5165;&#x5230;&#x78C1;&#x76D8;&#x7684;&#x6570;&#x636E;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/log.c</span>

<span class="token keyword">void</span>
<span class="token function">initlog</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">logheader</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> BSIZE<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tinitlog: logheader is too big.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">superblock</span> sb<span class="token punctuation">;</span>
    <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">,</span> <span class="token string">&quot;log&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">readsb</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span>start <span class="token operator">=</span> sb<span class="token punctuation">.</span>logstart<span class="token punctuation">;</span>
    log<span class="token punctuation">.</span>size <span class="token operator">=</span> sb<span class="token punctuation">.</span>nlog<span class="token punctuation">;</span>
    log<span class="token punctuation">.</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    <span class="token function">recover_from_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">&quot;initlog: success.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x5176;&#x4E2D;&#xFF0C;super block &#x4FDD;&#x5B58;&#x4E86;&#x78C1;&#x76D8;&#x7684;&#x5E03;&#x5C40;&#x4FE1;&#x606F;&#xFF0C;&#x8BE6;&#x89C1;&#x6CE8;&#x91CA;&#xFF1A;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// inc/fs.h</span>

<span class="token comment">/*
 * Disk layout:
 * [boot block | super block | log | inode blocks | free bit map | data blocks]
 *
 * mkfs computes the super block and builds an initial file system.
 * The super block describes the disk layout:
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">superblock</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint32_t</span> size<span class="token punctuation">;</span>        <span class="token comment">// Size of file system image (blocks)</span>
    <span class="token class-name">uint32_t</span> nblocks<span class="token punctuation">;</span>     <span class="token comment">// Number of data blocks</span>
    <span class="token class-name">uint32_t</span> ninodes<span class="token punctuation">;</span>     <span class="token comment">// Number of inodes</span>
    <span class="token class-name">uint32_t</span> nlog<span class="token punctuation">;</span>        <span class="token comment">// Number of log blocks</span>
    <span class="token class-name">uint32_t</span> logstart<span class="token punctuation">;</span>    <span class="token comment">// Block number of first log block</span>
    <span class="token class-name">uint32_t</span> inodestart<span class="token punctuation">;</span>  <span class="token comment">// Block number of first inode block</span>
    <span class="token class-name">uint32_t</span> bmapstart<span class="token punctuation">;</span>   <span class="token comment">// Block number of first free map block</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x6211;&#x4EEC;&#x5148;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>readsb</code> &#x8BFB;&#x53D6; super block&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token comment">/*
 * Read the super block.
 */</span>
<span class="token keyword">void</span>
<span class="token function">readsb</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">superblock</span><span class="token operator">*</span> sb<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> b <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memmove</span><span class="token punctuation">(</span>sb<span class="token punctuation">,</span> b<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>sb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">brelse</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x7136;&#x540E;&#x6211;&#x4EEC;&#x5229;&#x7528; super block &#x4E2D;&#x7684;&#x4FE1;&#x606F;&#x521D;&#x59CB;&#x5316; <code>log</code>&#xFF0C;&#x5176;&#x4E2D; <code>log</code> &#x7684;&#x7ED3;&#x6784;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/log.c</span>

<span class="token comment">/*
 * Contents of the header block, used for both the on-disk header block
 * and to keep track in memory of logged block # before commit.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">logheader</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> n<span class="token punctuation">;</span>
    <span class="token keyword">int</span> block<span class="token punctuation">[</span>LOGSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">log</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> lock<span class="token punctuation">;</span>
    <span class="token keyword">int</span> start<span class="token punctuation">;</span>
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>
    <span class="token keyword">int</span> outstanding<span class="token punctuation">;</span>  <span class="token comment">// How many FS sys calls are executing.</span>
    <span class="token keyword">int</span> committing<span class="token punctuation">;</span>   <span class="token comment">// In commit(), please wait.</span>
    <span class="token keyword">int</span> dev<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">logheader</span> lh<span class="token punctuation">;</span>
<span class="token punctuation">}</span> log<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x8FD9;&#x91CC; log header &#x4FDD;&#x5B58;&#x7684;&#x662F;&#x5DF2; commit &#x7684; block &#x7684;<strong>&#x6807;&#x53F7;</strong>&#x3002;</p>
<p><code>log</code> &#x521D;&#x59CB;&#x5316;&#x5B8C;&#x6BD5;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>recover_from_log</code> &#x8FDB;&#x884C;&#x78C1;&#x76D8;&#x7684;&#x6062;&#x590D;&#x5DE5;&#x4F5C;&#xFF0C;&#x4EE5;&#x7EF4;&#x62A4;&#x78C1;&#x76D8;&#x7684;&#x5D29;&#x6E83;&#x4E00;&#x81F4;&#x6027;&#x3002;</p>
<p>&#x51FD;&#x6570; <code>recover_from_log</code> &#x9996;&#x5148;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>read_head</code> &#x5C06;&#x78C1;&#x76D8;&#x4E2D;&#x7684; log header &#x8BFB;&#x53D6;&#x5230;&#x5185;&#x5B58;&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>install_trans</code> &#x6839;&#x636E; log header &#x5C06;&#x5DF2; commit &#x7684; block &#x5199;&#x5165;&#x5230;&#x78C1;&#x76D8;&#xFF0C;&#x6700;&#x540E;&#x6E05;&#x7A7A;&#x5185;&#x5B58;&#x4E2D;&#x7684; log header&#xFF0C;&#x5E76;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>write_head</code> &#x6E05;&#x7A7A;&#x78C1;&#x76D8;&#x4E2D;&#x7684; log header&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/log.c</span>

<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">recover_from_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">read_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">install_trans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// if committed, copy from log to disk</span>
    log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">write_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// clear the log</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x5177;&#x4F53;&#x6765;&#x8BF4;&#xFF0C;&#x51FD;&#x6570; <code>read_head</code> &#x5148;&#x8BFB;&#x53D6;&#x78C1;&#x76D8;&#x4E2D;&#x7684; log header&#xFF0C;&#x5E76;&#x5C06;&#x5176;&#x590D;&#x5236;&#x5230;&#x5185;&#x5B58;&#x4E2D;&#x7684; <code>log</code> &#x7ED3;&#x6784;&#x91CC;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/log.c</span>

<span class="token comment">/*
 * Read the log header from disk into the in-memory log header.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">read_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> buf <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>dev<span class="token punctuation">,</span> log<span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">logheader</span><span class="token operator">*</span> lh <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">logheader</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buf<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n <span class="token operator">=</span> lh<span class="token operator">-&gt;</span>n<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>block<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> lh<span class="token operator">-&gt;</span>block<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">brelse</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x968F;&#x540E;&#xFF0C;&#x51FD;&#x6570; <code>install_trans</code> &#x6839;&#x636E; log header &#x4E2D; block &#x7684;&#x6807;&#x53F7;&#xFF0C;&#x5C06;&#x78C1;&#x76D8;&#x4E2D;&#x5DF2; commit &#x4F46;&#x8FD8;&#x672A;&#x5199;&#x5165;&#x5230;&#x78C1;&#x76D8;&#x7684; block &#x7684;&#x5185;&#x5BB9;&#x590D;&#x5236;&#x5230;&#x4E00;&#x4E2A; <code>buf</code> &#x91CC;&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x5B83;&#x5199;&#x5165;&#x5230;&#x78C1;&#x76D8;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/log.c</span>

<span class="token comment">/*
 * Copy committed blocks from log to their home location.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">install_trans</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> log_buf <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>dev<span class="token punctuation">,</span> log<span class="token punctuation">.</span>start <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> dst_buf <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>dev<span class="token punctuation">,</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>block<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memmove</span><span class="token punctuation">(</span>dst_buf<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> log_buf<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> BSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">brelse</span><span class="token punctuation">(</span>log_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">bwrite</span><span class="token punctuation">(</span>dst_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">brelse</span><span class="token punctuation">(</span>dst_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x6700;&#x540E;&#xFF0C;&#x5C06;&#x5185;&#x5B58;&#x4E2D;&#x7684; log header &#x6E05;&#x7A7A;&#xFF0C;&#x5E76;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>write_head</code> &#x5C06;&#x5176;&#x5199;&#x5165;&#x5230;&#x78C1;&#x76D8;&#xFF0C;&#x4ECE;&#x800C;&#x5C06;&#x78C1;&#x76D8;&#x4E2D;&#x7684; log header &#x4E5F;&#x6E05;&#x7A7A;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/log.c</span>

<span class="token comment">/*
 * Write in-memory log header to disk.
 * This is the true point at which the
 * current transaction commits.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">write_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> buf <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>dev<span class="token punctuation">,</span> log<span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">logheader</span><span class="token operator">*</span> lh <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">logheader</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buf<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    lh<span class="token operator">-&gt;</span>n <span class="token operator">=</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> lh<span class="token operator">-&gt;</span>block<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>block<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">bwrite</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">brelse</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="132-log_write">1.3.2 <code>log_write</code></h5>

<p>&#x51FD;&#x6570; <code>log_write</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x7684; log header &#x91CC;&#x8BB0;&#x5F55;&#x9700;&#x8981;&#x88AB;&#x5199;&#x5165;&#x78C1;&#x76D8;&#x7684; block &#x7684;&#x6807;&#x53F7;&#xFF0C;&#x5E76;&#x6807;&#x8BB0;&#x8FD9;&#x4E2A; block &#x5BF9;&#x5E94;&#x7684; <code>buf</code> &#x4E3A; dirty&#xFF0C;&#x4EE5;&#x56FA;&#x5B9A;&#x5728; <code>bcache</code> &#x4E2D;&#xFF0C;&#x4E0D;&#x4F1A;&#x56E0; LRU &#x7B97;&#x6CD5;&#x88AB;&#x610F;&#x5916;&#x6DD8;&#x6C70;&#x3002;&#x8FD9;&#x4E9B; block &#x5C06;&#x5728;&#x4E4B;&#x540E;&#x88AB;&#x7EDF;&#x4E00;&#x8FDE;&#x7EED;&#x5199;&#x5165;&#x78C1;&#x76D8;&#xFF0C;&#x4ECE;&#x800C;&#x63D0;&#x9AD8;&#x6548;&#x7387;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/log.c</span>

<span class="token comment">/*
 * Caller has modified b-&gt;data and is done with the buffer.
 * Record the block number and pin in the cache with B_DIRTY.
 * commit() / write_log() will do the disk write.
 *
 * log_write() replaces bwrite(); a typical use is:
 *   bp = bread(...)
 *   modify bp-&gt;data[]
 *   log_write(bp)
 *   brelse(bp)
 */</span>
<span class="token keyword">void</span>
<span class="token function">log_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> b<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n <span class="token operator">&gt;=</span> LOGSIZE <span class="token operator">||</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n <span class="token operator">&gt;=</span> log<span class="token punctuation">.</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tlog_write: transaction is too big.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>outstanding <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tlog_write: outside of transaction.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>block<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> b<span class="token operator">-&gt;</span>blockno<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token comment">// log absorption</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>block<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token operator">-&gt;</span>blockno<span class="token punctuation">;</span>
        <span class="token operator">++</span>log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    b<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> B_DIRTY<span class="token punctuation">;</span>  <span class="token comment">// prevent eviction</span>
    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x8FD9;&#x91CC;&#x5F15;&#x5165;&#x4E86; absorption &#x7684;&#x4F18;&#x5316;&#x673A;&#x5236;&#x3002;&#x5F53;&#x5728;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x4E2D;&#x591A;&#x6B21;&#x5199;&#x5165;&#x540C;&#x4E00;&#x4E2A; block &#x65F6;&#xFF0C;&#x5728; log header &#x4E2D;&#x4EC5;&#x8BB0;&#x5F55;&#x4E00;&#x6B21;&#x8FD9;&#x4E2A; block &#x7684;&#x6807;&#x53F7;&#xFF0C;&#x4ECE;&#x800C;&#x8282;&#x7701; log header &#x7684;&#x7A7A;&#x95F4;&#xFF0C;&#x5E76;&#x63D0;&#x9AD8;&#x6548;&#x7387;&#x3002;</p>
<h5 class="mume-header" id="133-begin_op">1.3.3 <code>begin_op</code></h5>

<p>&#x51FD;&#x6570; <code>begin_op</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x5728;&#x4E8B;&#x52A1;&#x5F00;&#x59CB;&#x524D;&#xFF0C;&#x7B49;&#x5F85; <code>log</code> &#x7A7A;&#x95F2;&#xFF08;&#x4E0D;&#x5904;&#x4E8E;&#x6B63;&#x5728; commit &#x7684;&#x72B6;&#x6001;&#xFF09;&#x4E14;&#x53EF;&#x7528;&#xFF08;log header &#x6709;&#x8DB3;&#x591F;&#x7684;&#x7A7A;&#x95F4;&#x4FDD;&#x5B58;&#x65B0;&#x7684;&#x5F85;&#x5199; block &#x7684;&#x6807;&#x53F7;&#xFF09;&#xFF0C;&#x7136;&#x540E;&#x624D;&#x5141;&#x8BB8;&#x5F00;&#x59CB;&#x672C;&#x6B21;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/log.c</span>

<span class="token comment">/*
 * Called at the start of each FS system call.
 */</span>
<span class="token keyword">void</span>
<span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>committing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">,</span> <span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n <span class="token operator">+</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>outstanding <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> MAXOPBLOCKS <span class="token operator">&gt;</span> LOGSIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// This op might exhaust log space; wait for commit.</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">,</span> <span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token operator">++</span>log<span class="token punctuation">.</span>outstanding<span class="token punctuation">;</span>
            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="134-end_op">1.3.4 <code>end_op</code></h5>

<p>&#x51FD;&#x6570; <code>end_op</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x5728;&#x4E8B;&#x52A1;&#x7ED3;&#x675F;&#x540E;&#xFF0C;&#x5C06; log header &#x4E2D;&#x6807;&#x8BB0;&#x7684; block &#x7EDF;&#x4E00;&#x8FDE;&#x7EED;&#x5199;&#x5165;&#x78C1;&#x76D8;&#xFF0C;&#x5E76;&#x5524;&#x9192;&#x51FD;&#x6570; <code>begin_op</code> &#x4E2D;&#x7B49;&#x5F85; <code>log</code> &#x7A7A;&#x95F2;&#x4E14;&#x53EF;&#x7528;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/log.c</span>

<span class="token comment">/*
 * Called at the end of each FS system call.
 * Commits if this was the last outstanding operation.
 */</span>
<span class="token keyword">void</span>
<span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> do_commit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">--</span>log<span class="token punctuation">.</span>outstanding<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>committing<span class="token punctuation">)</span> <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tend_op: log is committing.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>log<span class="token punctuation">.</span>outstanding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        do_commit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span>committing <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// begin_op() may be waiting for log space, and decrementing</span>
        <span class="token comment">// log.outstanding has decreased the amount of reserved space.</span>
        <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>do_commit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span>committing <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x5177;&#x4F53;&#x6765;&#x8BF4;&#xFF0C;&#x5148;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x4E8B;&#x52A1;&#x662F;&#x5426;&#x5DF2;&#x7ED3;&#x675F;&#xFF08;&#x5373; outstanding &#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6570;&#x91CF;&#x4E3A; <code>0</code>&#xFF09;&#x3002;&#x5982;&#x679C;&#x662F;&#xFF0C;&#x5219;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>commit</code> &#x8FDB;&#x884C;&#x5199;&#x78C1;&#x76D8;&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x51FD;&#x6570; <code>commit</code> &#x9996;&#x5148;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>write_log</code> &#x5C06;&#x5F85; commit &#x7684; block &#x5199;&#x5165;&#x5230;&#x78C1;&#x76D8;&#x4E2D; <code>log</code> &#x5BF9;&#x5E94;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x63A5;&#x7740;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>write_head</code> &#x5C06;&#x5185;&#x5B58;&#x4E2D;&#x7684; log header &#x5199;&#x5165;&#x5230;&#x78C1;&#x76D8;&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>install_trans</code> &#x6839;&#x636E; log header &#x5C06;&#x5DF2; commit &#x7684; block &#x5199;&#x5165;&#x5230;&#x78C1;&#x76D8;&#xFF0C;&#x6700;&#x540E;&#x6E05;&#x7A7A;&#x5185;&#x5B58;&#x4E2D;&#x7684; log header&#xFF0C;&#x5E76;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>write_head</code> &#x6E05;&#x7A7A;&#x78C1;&#x76D8;&#x4E2D;&#x7684; log header&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/log.c</span>

<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">write_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">write_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">install_trans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">write_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// erase the transaction from the log</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x5177;&#x4F53;&#x6765;&#x8BF4;&#xFF0C;&#x51FD;&#x6570; <code>write_log</code> &#x6839;&#x636E; log header &#x4E2D; block &#x7684;&#x6807;&#x53F7;&#xFF0C;&#x5C06;&#x5F85; commit &#x7684; block &#x5199;&#x5165;&#x5230;&#x78C1;&#x76D8;&#x4E2D; <code>log</code> &#x5BF9;&#x5E94;&#x7684;&#x4F4D;&#x7F6E;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/log.c</span>

<span class="token comment">/*
 * Copy modified blocks from cache to log.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">write_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> log_buf <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>dev<span class="token punctuation">,</span> log<span class="token punctuation">.</span>start <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> cache_buf <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>dev<span class="token punctuation">,</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>block<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memmove</span><span class="token punctuation">(</span>log_buf<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> cache_buf<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> BSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">brelse</span><span class="token punctuation">(</span>cache_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">bwrite</span><span class="token punctuation">(</span>log_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">brelse</span><span class="token punctuation">(</span>log_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x968F;&#x540E;&#xFF0C;&#x51FD;&#x6570; <code>write_head</code> &#x5C06;&#x5185;&#x5B58;&#x4E2D;&#x7684; log header &#x5199;&#x5165;&#x5230;&#x78C1;&#x76D8;&#xFF0C;&#x6B64;&#x65F6;&#x4E8B;&#x52A1;&#x88AB; commit&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/log.c</span>

<span class="token comment">/*
 * Write in-memory log header to disk.
 * This is the true point at which the
 * current transaction commits.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">write_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> buf <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>dev<span class="token punctuation">,</span> log<span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">logheader</span><span class="token operator">*</span> lh <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">logheader</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buf<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    lh<span class="token operator">-&gt;</span>n <span class="token operator">=</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> lh<span class="token operator">-&gt;</span>block<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>block<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">bwrite</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">brelse</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x4E4B;&#x540E;&#x7684;&#x5199;&#x78C1;&#x76D8;&#x8FC7;&#x7A0B;&#x540C; 1.3.1 &#x8282;&#x4E2D;&#x51FD;&#x6570; <code>recover_from_log</code> &#x7684;&#x540E;&#x534A;&#x6BB5;&#x3002;</p>
<h4 class="mume-header" id="14-inode">1.4 Inode</h4>

<p>&#x7B2C; 4 &#x5C42;&#x662F;&#x7D22;&#x5F15;&#x8282;&#x70B9;&#xFF08;inode&#xFF09;&#xFF0C;&#x5305;&#x542B;&#x4E86;&#x6587;&#x4EF6;&#x7684;&#x5143;&#x4FE1;&#x606F;&#xFF0C;&#x7528;&#x4E8E;&#x63CF;&#x8FF0;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x5BF9;&#x8C61;&#x3002;&#x6211;&#x4EEC;&#x5C06;&#x5728; <code>kern/fs.c</code> &#x4E2D;&#x5B9E;&#x73B0;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E00;&#x5C42;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x4E86;&#x4EE5;&#x4E0B;&#x65B9;&#x6CD5;&#xFF1A;</p>
<ul>
<li><code>iinit</code>&#xFF1A;&#x521D;&#x59CB;&#x5316; <code>inode</code> &#x548C; <code>icache</code></li>
<li><code>ialloc</code>&#xFF1A;&#x5206;&#x914D;&#x4E00;&#x4E2A; <code>inode</code></li>
<li><code>iupdate</code>&#xFF1A;&#x5C06;&#x5185;&#x5B58;&#x4E2D;&#x7684; <code>inode</code> &#x5199;&#x5165;&#x5230;&#x78C1;&#x76D8;</li>
<li><code>idup</code>&#xFF1A;&#x5C06; <code>inode</code> &#x7684;&#x5F15;&#x7528;&#x6570;&#xFF08;<code>ref</code>&#xFF09;&#x52A0; <code>1</code>&#xFF0C;&#x5176;&#x4E2D;&#x5F15;&#x7528;&#x6570;&#x8868;&#x793A;&#x5F53;&#x524D;&#x5185;&#x5B58;&#x4E2D;&#x6307;&#x5411;&#x8FD9;&#x4E2A; <code>inode</code> &#x7684;&#x6307;&#x9488;&#x6570;&#x91CF;</li>
<li><code>ilock</code>&#xFF1A;&#x7ED9; <code>inode</code> &#x52A0;&#x9501;&#xFF0C;&#x9700;&#x8981;&#x65F6;&#x4ECE;&#x78C1;&#x76D8;&#x4E2D;&#x8BFB;&#x53D6; <code>inode</code></li>
<li><code>iunlock</code>&#xFF1A;&#x7ED9; <code>inode</code> &#x89E3;&#x9501;</li>
<li><code>iput</code>&#xFF1A;&#x5F53; <code>inode</code> &#x7684;&#x5F15;&#x7528;&#x6570;&#xFF08;<code>ref</code>&#xFF09;&#x4E3A; <code>1</code> &#x65F6;&#xFF0C;&#x6E05;&#x7A7A;&#x5E76;&#x91CA;&#x653E;&#x8BE5; <code>inode</code>&#xFF0C;&#x5426;&#x5219;&#x5C06;&#x5176;&#x5F15;&#x7528;&#x6570;&#x51CF; <code>1</code></li>
<li><code>iunlockput</code>&#xFF1A;<code>iunlock</code> + <code>iput</code> &#x7684;&#x522B;&#x540D;</li>
<li><code>stati</code>&#xFF1A;&#x590D;&#x5236; <code>inode</code> &#x7684;&#x5143;&#x6570;&#x636E;&#x5230; <code>stat</code></li>
<li><code>readi</code>&#xFF1A;&#x4ECE; <code>inode</code> &#x4E2D;&#x8BFB;&#x53D6;&#x6570;&#x636E;</li>
<li><code>writei</code>&#xFF1A;&#x5199;&#x5165;&#x6570;&#x636E;&#x5230; <code>inode</code></li>
</ul>
<h5 class="mume-header" id="141-iinit">1.4.1 <code>iinit</code></h5>

<p>&#x51FD;&#x6570; <code>iinit</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x521D;&#x59CB;&#x5316; <code>icache</code> &#x548C; <code>inode</code> &#x7684;&#x9501;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token keyword">void</span>
<span class="token function">iinit</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>lock<span class="token punctuation">,</span> <span class="token string">&quot;icache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NINODE<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token function">initsleeplock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>inode<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">,</span> <span class="token string">&quot;inode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">readsb</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cprintf</span><span class="token punctuation">(</span>
        <span class="token string">&quot;super block: size %d nblocks %d ninodes %d nlog %d logstart %d inodestart %d bmapstart %d\n&quot;</span><span class="token punctuation">,</span>
        sb<span class="token punctuation">.</span>size<span class="token punctuation">,</span> sb<span class="token punctuation">.</span>nblocks<span class="token punctuation">,</span> sb<span class="token punctuation">.</span>ninodes<span class="token punctuation">,</span> sb<span class="token punctuation">.</span>nlog<span class="token punctuation">,</span> sb<span class="token punctuation">.</span>logstart<span class="token punctuation">,</span> sb<span class="token punctuation">.</span>inodestart<span class="token punctuation">,</span>
        sb<span class="token punctuation">.</span>bmapstart<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">&quot;iinit: success.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x5176;&#x4E2D;&#xFF0C;<code>icache</code> &#x7684;&#x7ED3;&#x6784;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> lock<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">inode</span> inode<span class="token punctuation">[</span>NINODE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> icache<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p><code>inode</code> &#x7684;&#x7ED3;&#x6784;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<p><img src="./assets/dinode.png" alt="The representation of a file on disk"></p>
<p>&#x672C;&#x56FE;&#x5F15;&#x81EA; <em>xv6: a simple, Unix-like teaching operating system</em> <sup class="footnote-ref"><a href="#fn1" id="fnref1:1">[1:1]</a></sup>&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// inc/file.h</span>

<span class="token comment">/*
 * In-memory copy of an inode.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint32_t</span> dev<span class="token punctuation">;</span>           <span class="token comment">// Device number</span>
    <span class="token class-name">uint32_t</span> inum<span class="token punctuation">;</span>          <span class="token comment">// Inode number</span>
    <span class="token keyword">int</span> ref<span class="token punctuation">;</span>                <span class="token comment">// Reference count</span>
    <span class="token keyword">struct</span> <span class="token class-name">sleeplock</span> lock<span class="token punctuation">;</span>  <span class="token comment">// Protects everything below here</span>
    <span class="token keyword">int</span> valid<span class="token punctuation">;</span>              <span class="token comment">// Inode has been read from disk?</span>

    <span class="token class-name">uint16_t</span> type<span class="token punctuation">;</span>  <span class="token comment">// Copy of disk inode</span>
    <span class="token class-name">uint16_t</span> major<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> minor<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> nlink<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> size<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> addrs<span class="token punctuation">[</span>NDIRECT <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="142-ialloc">1.4.2 <code>ialloc</code></h5>

<p>&#x51FD;&#x6570; <code>ialloc</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x5728;&#x78C1;&#x76D8;&#x4E2D;&#x627E;&#x5230;&#x4E00;&#x4E2A;&#x672A;&#x5206;&#x914D;&#x7684; <code>inode</code>&#xFF08;<code>type</code> &#x4E3A; <code>0</code>&#xFF09;&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x5B83;&#x7684; <code>type</code> &#x8BBE;&#x7F6E;&#x4E3A;&#x7ED9;&#x5B9A;&#x7684;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#xFF0C;&#x8868;&#x793A;&#x5DF2;&#x5206;&#x914D;&#xFF0C;&#x6700;&#x540E;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>iget</code>&#xFF0C;&#x8FD4;&#x56DE;&#x8FD9;&#x4E2A; <code>inode</code> &#x5728;&#x5185;&#x5B58;&#x4E2D;&#x7684;&#x62F7;&#x8D1D;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token comment">/*
 * Allocate an inode on device dev.
 *
 * Mark it as allocated by giving it type type.
 * Returns an unlocked but allocated and referenced inode.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span>
<span class="token function">ialloc</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> dev<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> type<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> inum <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> inum <span class="token operator">&lt;</span> sb<span class="token punctuation">.</span>ninodes<span class="token punctuation">;</span> <span class="token operator">++</span>inum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token function">IBLOCK</span><span class="token punctuation">(</span>inum<span class="token punctuation">,</span> sb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">dinode</span><span class="token operator">*</span> dip <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dinode</span><span class="token operator">*</span><span class="token punctuation">)</span>bp<span class="token operator">-&gt;</span>data <span class="token operator">+</span> inum <span class="token operator">%</span> IPB<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dip<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// a free inode</span>
            <span class="token function">memset</span><span class="token punctuation">(</span>dip<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>dip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dip<span class="token operator">-&gt;</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
            <span class="token function">log_write</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// mark it allocated on the disk</span>
            <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">iget</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> inum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tialloc: no inodes.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x5176;&#x4E2D;&#xFF0C;&#x51FD;&#x6570; <code>iget</code> &#x5148;&#x5728; <code>icache</code> &#x4E2D;&#x6839;&#x636E;&#x6807;&#x53F7;&#xFF08;<code>inum</code>&#xFF09;&#x5BFB;&#x627E;&#x5BF9;&#x5E94;&#x7684; <code>inode</code>&#x3002;&#x5982;&#x679C;&#x627E;&#x5230;&#xFF0C;&#x5219;&#x5C06;&#x5176;&#x5F15;&#x7528;&#x6570;&#xFF08;<code>ref</code>&#xFF09;&#x52A0; <code>1</code> &#x5E76;&#x8FD4;&#x56DE;&#xFF0C;&#x5426;&#x5219;&#x5728; <code>icache</code> &#x4E2D;&#x56DE;&#x6536;&#x4E00;&#x4E2A;&#x7A7A;&#x95F2;&#x7684; cache entry &#x7ED9;&#x8FD9;&#x4E2A; <code>inode</code>&#xFF0C;&#x5C06;&#x5176;&#x5F15;&#x7528;&#x6570;&#xFF08;<code>ref</code>&#xFF09;&#x8BBE;&#x7F6E;&#x4E3A; <code>1</code> &#x5E76;&#x8FD4;&#x56DE;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token comment">/*
 * Find the inode with number inum on device dev
 * and return the in-memory copy. Does not lock
 * the inode and does not read it from disk.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span>
<span class="token function">iget</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> dev<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> inum<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Is the inode already cached?</span>
    <span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> empty <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NINODE<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> ip <span class="token operator">=</span> <span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>inode<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>ref <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ip<span class="token operator">-&gt;</span>dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> ip<span class="token operator">-&gt;</span>inum <span class="token operator">==</span> inum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ip<span class="token operator">-&gt;</span>ref<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ip<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>empty <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ip<span class="token operator">-&gt;</span>ref<span class="token punctuation">)</span> empty <span class="token operator">=</span> ip<span class="token punctuation">;</span>  <span class="token comment">// remember empty slot</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Recycle an inode cache entry.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>empty<span class="token punctuation">)</span> <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tiget: no inodes.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> ip <span class="token operator">=</span> empty<span class="token punctuation">;</span>
    ip<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    ip<span class="token operator">-&gt;</span>inum <span class="token operator">=</span> inum<span class="token punctuation">;</span>
    ip<span class="token operator">-&gt;</span>ref <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    ip<span class="token operator">-&gt;</span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ip<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="143-iupdate">1.4.3 <code>iupdate</code></h5>

<p>&#x51FD;&#x6570; <code>iupdate</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x5C06;&#x5185;&#x5B58;&#x4E2D;&#x7684; <code>inode</code> &#x5199;&#x5165;&#x5230;&#x78C1;&#x76D8;&#x3002;&#x7531;&#x4E8E;&#x6211;&#x4EEC;&#x7684; <code>icache</code> &#x91C7;&#x7528;&#x76F4;&#x5199;&#xFF08;write-through&#xFF09;&#x6A21;&#x5F0F;&#xFF0C;&#x56E0;&#x6B64;&#x6BCF;&#x5F53; <code>inode</code> &#x6709;&#x5B57;&#x6BB5;&#x88AB;&#x4FEE;&#x6539;&#xFF0C;&#x5C31;&#x9700;&#x8981;&#x8C03;&#x7528;&#x4E00;&#x6B21;&#x51FD;&#x6570; <code>iupdate</code> &#x8FDB;&#x884C;&#x5199;&#x56DE;&#x64CD;&#x4F5C;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token comment">/*
 * Copy a modified in-memory inode to disk.
 *
 * Must be called after every change to an ip-&gt;xxx field
 * that lives on disk, since i-node cache is write-through.
 * Caller must hold ip-&gt;lock.
 */</span>
<span class="token keyword">void</span>
<span class="token function">iupdate</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> ip<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token function">IBLOCK</span><span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>inum<span class="token punctuation">,</span> sb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">dinode</span><span class="token operator">*</span> dip <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dinode</span><span class="token operator">*</span><span class="token punctuation">)</span>bp<span class="token operator">-&gt;</span>data <span class="token operator">+</span> ip<span class="token operator">-&gt;</span>inum <span class="token operator">%</span> IPB<span class="token punctuation">;</span>
    dip<span class="token operator">-&gt;</span>type <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>type<span class="token punctuation">;</span>
    dip<span class="token operator">-&gt;</span>major <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>major<span class="token punctuation">;</span>
    dip<span class="token operator">-&gt;</span>minor <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>minor<span class="token punctuation">;</span>
    dip<span class="token operator">-&gt;</span>nlink <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>nlink<span class="token punctuation">;</span>
    dip<span class="token operator">-&gt;</span>size <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>
    <span class="token function">memmove</span><span class="token punctuation">(</span>dip<span class="token operator">-&gt;</span>addrs<span class="token punctuation">,</span> ip<span class="token operator">-&gt;</span>addrs<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>addrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">log_write</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="144-idup">1.4.4 <code>idup</code></h5>

<p>&#x51FD;&#x6570; <code>idup</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x5C06; <code>inode</code> &#x7684;&#x5F15;&#x7528;&#x6570;&#xFF08;<code>ref</code>&#xFF09;&#x52A0; <code>1</code>&#xFF0C;&#x5176;&#x4E2D;&#x5F15;&#x7528;&#x6570;&#x8868;&#x793A;&#x5F53;&#x524D;&#x5185;&#x5B58;&#x4E2D;&#x6307;&#x5411;&#x8FD9;&#x4E2A; <code>inode</code> &#x7684;&#x6307;&#x9488;&#x6570;&#x91CF;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token comment">/*
 * Increment reference count for ip.
 * Returns ip to enable ip = idup(ip1) idiom.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span>
<span class="token function">idup</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> ip<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ip<span class="token operator">-&gt;</span>ref<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ip<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="145-ilock">1.4.5 <code>ilock</code></h5>

<p>&#x51FD;&#x6570; <code>ilock</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x7ED9;&#x6307;&#x5B9A;&#x7684; <code>inode</code> &#x52A0;&#x9501;&#x3002;&#x5982;&#x679C;&#x5F53;&#x524D; <code>inode</code> &#x4E0D;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#xFF08;&#x5373; <code>valid</code> &#x4E3A; <code>0</code>&#xFF09;&#xFF0C;&#x5219;&#x4ECE;&#x78C1;&#x76D8;&#x4E2D;&#x8BFB;&#x53D6;&#xFF0C;&#x5E76;&#x5C06; <code>valid</code> &#x8BBE;&#x7F6E;&#x4E3A; <code>1</code>&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token comment">/*
 * Lock the given inode.
 * Reads the inode from disk if necessary.
 */</span>
<span class="token keyword">void</span>
<span class="token function">ilock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> ip<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ip <span class="token operator">||</span> ip<span class="token operator">-&gt;</span>ref <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tilock: invalid inode.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ip<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ip<span class="token operator">-&gt;</span>valid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token function">IBLOCK</span><span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>inum<span class="token punctuation">,</span> sb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">dinode</span><span class="token operator">*</span> dip <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dinode</span><span class="token operator">*</span><span class="token punctuation">)</span>bp<span class="token operator">-&gt;</span>data <span class="token operator">+</span> ip<span class="token operator">-&gt;</span>inum <span class="token operator">%</span> IPB<span class="token punctuation">;</span>
        ip<span class="token operator">-&gt;</span>type <span class="token operator">=</span> dip<span class="token operator">-&gt;</span>type<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ip<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tilock: no type.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ip<span class="token operator">-&gt;</span>major <span class="token operator">=</span> dip<span class="token operator">-&gt;</span>major<span class="token punctuation">;</span>
        ip<span class="token operator">-&gt;</span>minor <span class="token operator">=</span> dip<span class="token operator">-&gt;</span>minor<span class="token punctuation">;</span>
        ip<span class="token operator">-&gt;</span>nlink <span class="token operator">=</span> dip<span class="token operator">-&gt;</span>nlink<span class="token punctuation">;</span>
        ip<span class="token operator">-&gt;</span>size <span class="token operator">=</span> dip<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>
        <span class="token function">memmove</span><span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>addrs<span class="token punctuation">,</span> dip<span class="token operator">-&gt;</span>addrs<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>addrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ip<span class="token operator">-&gt;</span>valid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="146-iunlock">1.4.6 <code>iunlock</code></h5>

<p>&#x51FD;&#x6570; <code>iunlock</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x7ED9;&#x6307;&#x5B9A;&#x7684; <code>inode</code> &#x89E3;&#x9501;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token comment">/*
 * Unlock the given inode.
 */</span>
<span class="token keyword">void</span>
<span class="token function">iunlock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> ip<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ip <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">holdingsleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ip<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span> <span class="token operator">||</span> ip<span class="token operator">-&gt;</span>ref <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tiunlock: invalid inode.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">releasesleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ip<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="147-iput">1.4.7 <code>iput</code></h5>

<p>&#x51FD;&#x6570; <code>iput</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x5F53; <code>inode</code> &#x7684;&#x5F15;&#x7528;&#x6570;&#xFF08;<code>ref</code>&#xFF09;&#x4E3A; <code>1</code> &#x65F6;&#xFF0C;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>itrunc</code> &#x6E05;&#x7A7A;&#x5E76;&#x91CA;&#x653E;&#x8BE5; <code>inode</code> &#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>iupdate</code> &#x66F4;&#x65B0;&#x78C1;&#x76D8;&#x4E2D;&#x7684; <code>inode</code>&#xFF1B;&#x5426;&#x5219;&#x5C06;&#x5176;&#x5F15;&#x7528;&#x6570;&#x51CF; <code>1</code>&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token comment">/*
 * Drop a reference to an in-memory inode.
 *
 * If that was the last reference, the inode cache entry can
 * be recycled.
 * If that was the last reference and the inode has no links
 * to it, free the inode (and its content) on disk.
 * All calls to iput() must be inside a transaction in
 * case it has to free the inode.
 */</span>
<span class="token keyword">void</span>
<span class="token function">iput</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> ip<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>ref <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> ip<span class="token operator">-&gt;</span>valid <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ip<span class="token operator">-&gt;</span>nlink<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ip-&gt;ref == 1 means no other process can have ip locked,</span>
        <span class="token comment">// so this acquiresleep() won&apos;t block (or deadlock).</span>
        <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ip<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// inode has no links and no other references: truncate and free.</span>
        <span class="token function">itrunc</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ip<span class="token operator">-&gt;</span>type <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">iupdate</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ip<span class="token operator">-&gt;</span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token function">releasesleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ip<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ip<span class="token operator">-&gt;</span>ref<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x8FD9;&#x91CC;&#x51FD;&#x6570; <code>itrunc</code> &#x7528;&#x4E8E;&#x6E05;&#x7A7A; <code>inode</code> &#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x5305;&#x62EC; <code>NDIRECT</code> &#x4E2A;&#x76F4;&#x63A5;&#x7D22;&#x5F15;&#x78C1;&#x76D8;&#x5757;&#xFF08;direct block&#xFF09;&#x548C; <code>NINDIRECT</code> &#x4E2A;&#x95F4;&#x63A5;&#x7D22;&#x5F15;&#x78C1;&#x76D8;&#x5757;&#xFF08;indirect block&#xFF09;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token comment">/*
 * Truncate inode (discard contents).
 *
 * Only called when the inode has no links
 * to it (no directory entries referring to it)
 * and has no in-memory reference to it (is
 * not an open file or current directory).
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">itrunc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> ip<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NDIRECT<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>addrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">bfree</span><span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> ip<span class="token operator">-&gt;</span>addrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ip<span class="token operator">-&gt;</span>addrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> ip<span class="token operator">-&gt;</span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">uint32_t</span><span class="token operator">*</span> a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token operator">*</span><span class="token punctuation">)</span>bp<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> NINDIRECT<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">bfree</span><span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">bfree</span><span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> ip<span class="token operator">-&gt;</span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ip<span class="token operator">-&gt;</span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ip<span class="token operator">-&gt;</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">iupdate</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x5176;&#x4E2D;&#xFF0C;&#x51FD;&#x6570; <code>bfree</code> &#x7528;&#x4E8E;&#x91CA;&#x653E;&#x4E00;&#x4E2A; block&#xFF0C;&#x5C06;&#x5176;&#x5728; bitmap &#x4E2D;&#x6807;&#x8BB0;&#x4E3A;&#x672A;&#x4F7F;&#x7528;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token comment">/*
 * Free a disk block.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">bfree</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> b<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token function">BBLOCK</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> sb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> bi <span class="token operator">=</span> b <span class="token operator">%</span> BPB<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>bi <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>bp<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>bi <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> m<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tbfree: freeing a free block.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bp<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>bi <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>m<span class="token punctuation">;</span>
    <span class="token function">log_write</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="148-iunlockput">1.4.8 <code>iunlockput</code></h5>

<p>&#x51FD;&#x6570; <code>iunlockput</code> &#x662F; <code>iunlock</code> + <code>iput</code> &#x7684;&#x522B;&#x540D;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token comment">/*
 * Common idiom: unlock, then put.
 */</span>
<span class="token keyword">void</span>
<span class="token function">iunlockput</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> ip<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">iunlock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="149-stati">1.4.9 <code>stati</code></h5>

<p>&#x51FD;&#x6570; <code>stati</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x590D;&#x5236; <code>inode</code> &#x7684;&#x5143;&#x6570;&#x636E;&#xFF08;metadata&#xFF09;&#x5230; <code>stat</code> &#x7ED3;&#x6784;&#xFF0C;&#x5C4A;&#x65F6;&#x7528;&#x6237;&#x7A0B;&#x5E8F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; <code>stat</code> &#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x8BFB;&#x53D6;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token comment">/*
 * Copy stat information from inode.
 * Caller must hold ip-&gt;lock.
 */</span>
<span class="token keyword">void</span>
<span class="token function">stati</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> ip<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">stat</span><span class="token operator">*</span> st<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// FIXME: Support other fields in stat.</span>
    st<span class="token operator">-&gt;</span>st_dev <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span>
    st<span class="token operator">-&gt;</span>st_ino <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>inum<span class="token punctuation">;</span>
    st<span class="token operator">-&gt;</span>st_nlink <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>nlink<span class="token punctuation">;</span>
    st<span class="token operator">-&gt;</span>st_size <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> T_FILE<span class="token operator">:</span> st<span class="token operator">-&gt;</span>st_mode <span class="token operator">=</span> S_IFREG<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> T_DIR<span class="token operator">:</span> st<span class="token operator">-&gt;</span>st_mode <span class="token operator">=</span> S_IFDIR<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> T_DEV<span class="token operator">:</span> st<span class="token operator">-&gt;</span>st_mode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tstati: unexpected stat type %d.\n&quot;</span><span class="token punctuation">,</span> ip<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="1410-readi">1.4.10 <code>readi</code></h5>

<p>&#x51FD;&#x6570; <code>readi</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x4ECE; <code>inode</code> &#x4E2D;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x3002;&#x5177;&#x4F53;&#x6765;&#x8BF4;&#xFF0C;&#x5148;&#x786E;&#x4FDD;&#x6570;&#x636E;&#x7684;&#x8BFB;&#x53D6;&#x8303;&#x56F4;&#x5728;&#x6587;&#x4EF6;&#x5185;&#xFF0C;&#x7136;&#x540E;&#x5229;&#x7528;&#x51FD;&#x6570; <code>bmap</code> &#x5B9A;&#x4F4D;&#x6587;&#x4EF6;&#x4E2D; block &#x7684;&#x5730;&#x5740;&#x5E76;&#x8BFB;&#x53D6;&#x5230; <code>buf</code>&#xFF0C;&#x63A5;&#x7740;&#x5C06;&#x6570;&#x636E;&#x4ECE; <code>buf</code> &#x590D;&#x5236;&#x5230;&#x76EE;&#x6807;&#x5730;&#x5740; <code>dst</code>&#xFF0C;&#x6700;&#x540E;&#x8FD4;&#x56DE;&#x6210;&#x529F;&#x8BFB;&#x53D6;&#x7684; block &#x6570;&#x91CF;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token comment">/*
 * Read data from inode.
 * Caller must hold ip-&gt;lock.
 */</span>
<span class="token class-name">ssize_t</span>
<span class="token function">readi</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> ip<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> dst<span class="token punctuation">,</span> <span class="token class-name">size_t</span> off<span class="token punctuation">,</span> <span class="token class-name">size_t</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>type <span class="token operator">==</span> T_DEV<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>major <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> ip<span class="token operator">-&gt;</span>major <span class="token operator">&gt;=</span> NDEV <span class="token operator">||</span> <span class="token operator">!</span>devsw<span class="token punctuation">[</span>ip<span class="token operator">-&gt;</span>major<span class="token punctuation">]</span><span class="token punctuation">.</span>read<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> devsw<span class="token punctuation">[</span>ip<span class="token operator">-&gt;</span>major<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>off <span class="token operator">&gt;</span> ip<span class="token operator">-&gt;</span>size <span class="token operator">||</span> off <span class="token operator">+</span> n <span class="token operator">&lt;</span> off<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>off <span class="token operator">+</span> n <span class="token operator">&gt;</span> ip<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span> n <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>size <span class="token operator">-</span> off<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> tot <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> m <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> tot <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> tot <span class="token operator">+=</span> m<span class="token punctuation">,</span> off <span class="token operator">+=</span> m<span class="token punctuation">,</span> dst <span class="token operator">+=</span> m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token function">bmap</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> off <span class="token operator">/</span> BSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>n <span class="token operator">-</span> tot<span class="token punctuation">,</span> BSIZE <span class="token operator">-</span> off <span class="token operator">%</span> BSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memmove</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> bp<span class="token operator">-&gt;</span>data <span class="token operator">+</span> off <span class="token operator">%</span> BSIZE<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x8FD9;&#x91CC;&#x51FD;&#x6570; <code>bmap</code> &#x6839;&#x636E; block &#x7684;&#x6807;&#x53F7;&#x627E;&#x5230;&#x5176;&#x5BF9;&#x5E94;&#x7684;&#x5730;&#x5740;&#x5E76;&#x8FD4;&#x56DE;&#xFF0C;&#x5176;&#x4E2D; direct block &#x7684;&#x5730;&#x5740;&#x4F4D;&#x4E8E;&#x6570;&#x7EC4; <code>ip-&gt;addrs</code> &#x4E2D;&#xFF0C;indirect block &#x7684;&#x5730;&#x5740;&#x4F4D;&#x4E8E; <code>ip-&gt;addrs[NDIRECT]</code> &#x6307;&#x5411;&#x7684; block &#x6240;&#x4FDD;&#x5B58;&#x7684;&#x6570;&#x7EC4;&#x4E2D;&#x3002;&#x5982;&#x679C;&#x53D1;&#x73B0;&#x627E;&#x4E0D;&#x5230;&#x5BF9;&#x5E94;&#x7684; block&#xFF0C;&#x5219;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>balloc</code> &#x5206;&#x914D;&#x4E00;&#x4E2A;&#x65B0;&#x7684; block&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token comment">/*
 * Inode content
 *
 * The content (data) associated with each inode is stored
 * in blocks on the disk. The first NDIRECT block numbers
 * are listed in ip-&gt;addrs[].  The next NINDIRECT blocks are
 * listed in block ip-&gt;addrs[NDIRECT].
 *
 * Return the disk block address of the nth block in inode ip.
 * If there is no such block, bmap allocates one.
 */</span>
<span class="token keyword">static</span> <span class="token class-name">uint32_t</span>
<span class="token function">bmap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> ip<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> bn<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bn <span class="token operator">&lt;</span> NDIRECT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Load direct block, allocating if necessary.</span>
        <span class="token class-name">uint32_t</span> addr <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>addrs<span class="token punctuation">[</span>bn<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>addr<span class="token punctuation">)</span> ip<span class="token operator">-&gt;</span>addrs<span class="token punctuation">[</span>bn<span class="token punctuation">]</span> <span class="token operator">=</span> addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> addr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    bn <span class="token operator">-=</span> NDIRECT<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>bn <span class="token operator">&lt;</span> NINDIRECT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Load indirect block, allocating if necessary.</span>
        <span class="token class-name">uint32_t</span> addr <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>addr<span class="token punctuation">)</span> ip<span class="token operator">-&gt;</span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span> <span class="token operator">=</span> addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">uint32_t</span><span class="token operator">*</span> a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token operator">*</span><span class="token punctuation">)</span>bp<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
        addr <span class="token operator">=</span> a<span class="token punctuation">[</span>bn<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            a<span class="token punctuation">[</span>bn<span class="token punctuation">]</span> <span class="token operator">=</span> addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">log_write</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> addr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tbmap: out of range.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x5176;&#x4E2D;&#xFF0C;&#x51FD;&#x6570; <code>balloc</code> &#x6839;&#x636E; block &#x5728; bitmap &#x4E2D;&#x6240;&#x5BF9;&#x5E94;&#x7684;&#x4F4D;&#xFF0C;&#x904D;&#x5386;&#x6240;&#x6709; block &#x627E;&#x5230;&#x4E00;&#x4E2A;&#x53EF;&#x7528;&#x7684; block&#xFF0C;&#x5C06;&#x5176;&#x5728; bitmap &#x4E2D;&#x6807;&#x8BB0;&#x4E3A;&#x4F7F;&#x7528;&#x4E2D;&#xFF0C;&#x5E76;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>bzero</code> &#x6E05;&#x7A7A;&#x6B64; block&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token comment">/*
 * Allocate a zeroed disk block.
 */</span>
<span class="token keyword">static</span> <span class="token class-name">uint32_t</span>
<span class="token function">balloc</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> b <span class="token operator">&lt;</span> sb<span class="token punctuation">.</span>size<span class="token punctuation">;</span> b <span class="token operator">+=</span> BPB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token function">BBLOCK</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> sb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> bi <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> bi <span class="token operator">&lt;</span> BPB <span class="token operator">&amp;&amp;</span> b <span class="token operator">+</span> bi <span class="token operator">&lt;</span> sb<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>bi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>bi <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>bp<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>bi <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> m<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// Is block free?</span>
                bp<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>bi <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">|=</span> m<span class="token punctuation">;</span>      <span class="token comment">// Mark block in use.</span>
                <span class="token function">log_write</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">bzero</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> b <span class="token operator">+</span> bi<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> b <span class="token operator">+</span> bi<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tballoc: out of blocks.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x51FD;&#x6570; <code>bzero</code> &#x7528;&#x4E8E;&#x6E05;&#x7A7A;&#x4E00;&#x4E2A; block&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token comment">/*
 * Zero a block.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">bzero</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> bno<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> b <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> bno<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>b<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> BSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">log_write</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">brelse</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="1411-writei">1.4.11 <code>writei</code></h5>

<p>&#x51FD;&#x6570; <code>writei</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x5199;&#x5165;&#x6570;&#x636E;&#x5230; <code>inode</code>&#x3002;&#x5177;&#x4F53;&#x6765;&#x8BF4;&#xFF0C;&#x5148;&#x786E;&#x4FDD;&#x6570;&#x636E;&#x7684;&#x5199;&#x5165;&#x8D77;&#x59CB;&#x5730;&#x5740;&#x5728;&#x6587;&#x4EF6;&#x5185;&#xFF0C;&#x4E14;&#x5199;&#x5165;&#x7ED3;&#x675F;&#x5730;&#x5740;&#x4E0D;&#x8D85;&#x8FC7;&#x6700;&#x5927;&#x6587;&#x4EF6;&#x5927;&#x5C0F; <code>MAXFILE * BSIZE</code>&#xFF0C;&#x7136;&#x540E;&#x5229;&#x7528;&#x51FD;&#x6570; <code>bmap</code> &#x5B9A;&#x4F4D;&#x6587;&#x4EF6;&#x4E2D; block &#x7684;&#x5730;&#x5740;&#x5E76;&#x8BFB;&#x53D6;&#x5230; <code>buf</code>&#xFF0C;&#x63A5;&#x7740;&#x5C06;&#x6570;&#x636E;&#x4ECE;&#x6E90;&#x5730;&#x5740; <code>src</code> &#x590D;&#x5236;&#x5230; <code>buf</code>&#xFF0C;&#x5E76;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>log_write</code> &#x52A0;&#x5165;&#x5199;&#x78C1;&#x76D8;&#x961F;&#x5217;&#xFF0C;&#x6700;&#x540E;&#x8FD4;&#x56DE;&#x6210;&#x529F;&#x5199;&#x5165;&#x7684; block &#x6570;&#x91CF;&#x3002;&#x5176;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x5199;&#x5165;&#x7684; block &#x6570;&#x91CF;&#x8D85;&#x8FC7;&#x6587;&#x4EF6;&#x5927;&#x5C0F;&#xFF0C;&#x6587;&#x4EF6;&#x5C06;&#x81EA;&#x52A8;&#x6269;&#x5BB9;&#xFF0C;&#x6700;&#x540E;&#x9700;&#x8981;&#x66F4;&#x65B0;&#x6B64;&#x6587;&#x4EF6;&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x5E76;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>iupdate</code> &#x5199;&#x5165;&#x5230;&#x78C1;&#x76D8;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/fs.c</span>

<span class="token comment">/*
 * Write data to inode.
 * Caller must hold ip-&gt;lock.
 */</span>
<span class="token class-name">ssize_t</span>
<span class="token function">writei</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> ip<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> src<span class="token punctuation">,</span> <span class="token class-name">size_t</span> off<span class="token punctuation">,</span> <span class="token class-name">size_t</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>type <span class="token operator">==</span> T_DEV<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>major <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> ip<span class="token operator">-&gt;</span>major <span class="token operator">&gt;=</span> NDEV <span class="token operator">||</span> <span class="token operator">!</span>devsw<span class="token punctuation">[</span>ip<span class="token operator">-&gt;</span>major<span class="token punctuation">]</span><span class="token punctuation">.</span>write<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> devsw<span class="token punctuation">[</span>ip<span class="token operator">-&gt;</span>major<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> src<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>off <span class="token operator">&gt;</span> ip<span class="token operator">-&gt;</span>size <span class="token operator">||</span> off <span class="token operator">+</span> n <span class="token operator">&lt;</span> off<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>off <span class="token operator">+</span> n <span class="token operator">&gt;</span> MAXFILE <span class="token operator">*</span> BSIZE<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> tot <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> m <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> tot <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> tot <span class="token operator">+=</span> m<span class="token punctuation">,</span> off <span class="token operator">+=</span> m<span class="token punctuation">,</span> src <span class="token operator">+=</span> m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span> bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token function">bmap</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> off <span class="token operator">/</span> BSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>n <span class="token operator">-</span> tot<span class="token punctuation">,</span> BSIZE <span class="token operator">-</span> off <span class="token operator">%</span> BSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memmove</span><span class="token punctuation">(</span>bp<span class="token operator">-&gt;</span>data <span class="token operator">+</span> off <span class="token operator">%</span> BSIZE<span class="token punctuation">,</span> src<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">log_write</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> off <span class="token operator">&gt;</span> ip<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ip<span class="token operator">-&gt;</span>size <span class="token operator">=</span> off<span class="token punctuation">;</span>
        <span class="token function">iupdate</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h4 class="mume-header" id="15-directory">1.5 Directory</h4>

<p>&#x7B2C; 5 &#x5C42;&#x662F;&#x76EE;&#x5F55;&#xFF0C;&#x7528;&#x4E8E;&#x7EC4;&#x7EC7;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684;&#x5C42;&#x6B21;&#x7ED3;&#x6784;&#xFF08;hierarchy&#xFF09;&#x3002;&#x52A9;&#x6559;&#x5DF2;&#x5728; <code>kern/fs.c</code> &#x4E2D;&#x5B9E;&#x73B0;&#xFF0C;&#x7531;&#x4E8E;&#x65F6;&#x95F4;&#x6709;&#x9650;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x8BE6;&#x7EC6;&#x9610;&#x8FF0;&#x4E86;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E00;&#x5C42;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x4E86;&#x4EE5;&#x4E0B;&#x65B9;&#x6CD5;&#xFF1A;</p>
<ul>
<li><code>namecmp</code>&#xFF1A;&#x6309;&#x5B57;&#x5178;&#x5E8F;&#x6BD4;&#x8F83;&#x4E24;&#x4E2A;&#x76EE;&#x5F55;&#x540D;&#x7684;&#x5927;&#x5C0F;</li>
<li><code>dirlookup</code>&#xFF1A;&#x5728;&#x4E00;&#x4E2A;&#x76EE;&#x5F55;&#x4E0B;&#x67E5;&#x627E;&#x6307;&#x5B9A;&#x540D;&#x79F0;&#x7684;&#x6587;&#x4EF6;&#x5939;</li>
<li><code>dirlink</code>&#xFF1A;&#x5728;&#x4E00;&#x4E2A;&#x76EE;&#x5F55;&#x4E0B;&#x65B0;&#x5EFA;&#x6307;&#x5B9A;&#x540D;&#x79F0;&#x7684;&#x6587;&#x4EF6;&#x5939;</li>
</ul>
<h4 class="mume-header" id="16-pathname">1.6 Pathname</h4>

<p>&#x7B2C; 6 &#x5C42;&#x662F;&#x8DEF;&#x5F84;&#xFF0C;&#x7528;&#x4E8E;&#x4EE5;&#x5B57;&#x7B26;&#x4E32;&#x8868;&#x793A;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x6216;&#x6587;&#x4EF6;&#x5939;&#x5728;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x4F4D;&#x7F6E;&#x3002;&#x52A9;&#x6559;&#x5DF2;&#x5728; <code>kern/fs.c</code> &#x4E2D;&#x5B9E;&#x73B0;&#xFF0C;&#x7531;&#x4E8E;&#x65F6;&#x95F4;&#x6709;&#x9650;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x8BE6;&#x7EC6;&#x9610;&#x8FF0;&#x4E86;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E00;&#x5C42;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x4E86;&#x4EE5;&#x4E0B;&#x65B9;&#x6CD5;&#xFF1A;</p>
<ul>
<li><code>namei</code>&#xFF1A;&#x67E5;&#x627E;&#x6307;&#x5B9A;&#x8DEF;&#x5F84;&#x7684;&#x6587;&#x4EF6;&#x6216;&#x6587;&#x4EF6;&#x5939;</li>
<li><code>nameiparent</code>&#xFF1A;&#x67E5;&#x627E;&#x6307;&#x5B9A;&#x8DEF;&#x5F84;&#x7684;&#x7236;&#x6587;&#x4EF6;&#x5939;</li>
</ul>
<h4 class="mume-header" id="17-file-descriptor">1.7 File descriptor</h4>

<p>&#x7B2C; 7 &#x5C42;&#x662F;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;&#x4EE5;&#x975E;&#x8D1F;&#x6574;&#x6570;&#x7684;&#x5F62;&#x5F0F;&#xFF0C;&#x8868;&#x793A;&#x4E00;&#x4E2A;&#x5DF2;&#x6253;&#x5F00;&#x6587;&#x4EF6;&#xFF08;&#x6216;&#x7BA1;&#x9053;&#x3001;socket &#x7B49;&#xFF0C;&#x4E00;&#x5207;&#x7686;&#x6587;&#x4EF6;&#xFF01;&#xFF09;&#x7684;&#x5F15;&#x7528;&#x3002;&#x5185;&#x6838;&#x4E3A;&#x6BCF;&#x4E2A;&#x8FDB;&#x7A0B;&#x7EF4;&#x62A4;&#x4E86;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x7EA7;&#x6587;&#x4EF6;&#x8868;&#xFF08;file table&#xFF09;&#xFF0C;&#x540C;&#x65F6;&#x5728;&#x5168;&#x5C40;&#x7EF4;&#x62A4;&#x4E86;&#x4E00;&#x4E2A;&#x7CFB;&#x7EDF;&#x7EA7;&#x6587;&#x4EF6;&#x8868;&#xFF08;global file table&#xFF0C;&#x6216; <code>ftable</code>&#xFF09;&#xFF0C;&#x5305;&#x542B;&#x4E86;&#x6240;&#x6709;&#x6253;&#x5F00;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#x5B9E;&#x9645;&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#x8868;&#x7684;&#x7D22;&#x5F15;&#x3002;&#x6211;&#x4EEC;&#x5C06;&#x5728; <code>kern/file.c</code> &#x4E2D;&#x5B9E;&#x73B0;&#x3002;&#x7531;&#x4E8E;&#x65F6;&#x95F4;&#x6709;&#x9650;&#xFF0C;&#x6211;&#x4EEC;&#x76EE;&#x524D;&#x4EC5;&#x652F;&#x6301;&#x666E;&#x901A;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E00;&#x5C42;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x4E86;&#x4EE5;&#x4E0B;&#x65B9;&#x6CD5;&#xFF1A;</p>
<ul>
<li><code>file_init</code>&#xFF1A;&#x521D;&#x59CB;&#x5316; <code>ftable</code></li>
<li><code>file_alloc</code>&#xFF1A;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x65B0;&#x6587;&#x4EF6;</li>
<li><code>file_dup</code>&#xFF1A;&#x5C06;&#x6587;&#x4EF6;&#x7684;&#x5F15;&#x7528;&#x6570;&#xFF08;<code>ref</code>&#xFF09;&#x52A0; <code>1</code></li>
<li><code>file_close</code>&#xFF1A;&#x5C06;&#x6587;&#x4EF6;&#x7684;&#x5F15;&#x7528;&#x6570;&#xFF08;<code>ref</code>&#xFF09;&#x51CF; <code>1</code>&#xFF0C;&#x5F53;&#x5F15;&#x7528;&#x6570;&#x964D;&#x5230; <code>0</code> &#x65F6;&#x5173;&#x95ED;&#x6587;&#x4EF6;</li>
<li><code>file_stat</code>&#xFF1A;&#x8BFB;&#x53D6;&#x6587;&#x4EF6;&#x7684;&#x5143;&#x6570;&#x636E;</li>
<li><code>file_read</code>&#xFF1A;&#x4ECE;&#x6587;&#x4EF6;&#x8BFB;&#x53D6;&#x6570;&#x636E;</li>
<li><code>file_write</code>&#xFF1A;&#x5199;&#x5165;&#x6570;&#x636E;&#x5230;&#x6587;&#x4EF6;</li>
</ul>
<h5 class="mume-header" id="171-file_init">1.7.1 <code>file_init</code></h5>

<p>&#x51FD;&#x6570; <code>file_init</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x521D;&#x59CB;&#x5316; <code>ftable</code> &#x7684;&#x9501;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/file.c</span>

<span class="token keyword">void</span>
<span class="token function">file_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ftable<span class="token punctuation">.</span>lock<span class="token punctuation">,</span> <span class="token string">&quot;ftable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x5176;&#x4E2D;&#xFF0C;<code>ftable</code> &#x7684;&#x7ED3;&#x6784;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/file.c</span>

<span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> lock<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">file</span> file<span class="token punctuation">[</span>NFILE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> ftable<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p><code>file</code> &#x7684;&#x7ED3;&#x6784;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// inc/file.h</span>

<span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token punctuation">{</span>
    <span class="token keyword">enum</span> <span class="token punctuation">{</span> FD_NONE<span class="token punctuation">,</span> FD_PIPE<span class="token punctuation">,</span> FD_INODE <span class="token punctuation">}</span> type<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ref<span class="token punctuation">;</span>
    <span class="token keyword">char</span> readable<span class="token punctuation">;</span>
    <span class="token keyword">char</span> writable<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pipe</span><span class="token operator">*</span> pipe<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> ip<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> off<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="172-file_alloc">1.7.2 <code>file_alloc</code></h5>

<p>&#x51FD;&#x6570; <code>file_alloc</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x5728; <code>ftable</code> &#x4E2D;&#x627E;&#x5230;&#x4E00;&#x4E2A;&#x672A;&#x4F7F;&#x7528;&#x7684;&#x6587;&#x4EF6;&#xFF08;<code>ref</code> &#x4E3A; <code>0</code>&#xFF09;&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x5B83;&#x6807;&#x8BB0;&#x4E3A;&#x4F7F;&#x7528;&#x4E2D;&#x5E76;&#x8FD4;&#x56DE;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/file.c</span>

<span class="token comment">/*
 * Allocate a file structure.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span>
<span class="token function">file_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ftable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> f <span class="token operator">=</span> ftable<span class="token punctuation">.</span>file<span class="token punctuation">;</span> f <span class="token operator">&lt;</span> ftable<span class="token punctuation">.</span>file <span class="token operator">+</span> NFILE<span class="token punctuation">;</span> <span class="token operator">++</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token operator">-&gt;</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            f<span class="token operator">-&gt;</span>ref <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ftable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> f<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ftable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="173-file_dup">1.7.3 <code>file_dup</code></h5>

<p>&#x51FD;&#x6570; <code>file_dup</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x5C06;&#x6587;&#x4EF6;&#x7684;&#x5F15;&#x7528;&#x6570;&#xFF08;<code>ref</code>&#xFF09;&#x52A0; <code>1</code>&#xFF0C;&#x8868;&#x793A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x6B64;&#x6587;&#x4EF6;&#x7684;&#x5F15;&#x7528;&#x62F7;&#x8D1D;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/file.c</span>

<span class="token comment">/*
 * Increment ref count for file f.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span>
<span class="token function">file_dup</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> f<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ftable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>ref <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tfile_dup: invalid file.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    f<span class="token operator">-&gt;</span>ref<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ftable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> f<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="174-file_close">1.7.4 <code>file_close</code></h5>

<p>&#x51FD;&#x6570; <code>file_close</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x5C06;&#x6587;&#x4EF6;&#x7684;&#x5F15;&#x7528;&#x6570;&#xFF08;<code>ref</code>&#xFF09;&#x51CF; <code>1</code>&#xFF1B;&#x5F53;&#x5F15;&#x7528;&#x6570;&#x964D;&#x5230; <code>0</code> &#x65F6;&#xFF0C;&#x5BF9;&#x4E8E;&#x666E;&#x901A;&#x6587;&#x4EF6;&#xFF0C;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>iput</code> &#x5173;&#x95ED;&#x6587;&#x4EF6;&#xFF08;&#x6682;&#x4E0D;&#x652F;&#x6301;&#x5176;&#x4ED6;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#xFF09;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/file.c</span>

<span class="token comment">/*
 * Close file f. (Decrement ref count, close when reaches 0.)
 */</span>
<span class="token keyword">void</span>
<span class="token function">file_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> f<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ftable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>ref <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tfile_close: invalid file.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>f<span class="token operator">-&gt;</span>ref <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ftable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">struct</span> <span class="token class-name">file</span> ff <span class="token operator">=</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>
    f<span class="token operator">-&gt;</span>ref <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    f<span class="token operator">-&gt;</span>type <span class="token operator">=</span> FD_NONE<span class="token punctuation">;</span>
    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ftable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ff<span class="token punctuation">.</span>type <span class="token operator">==</span> FD_INODE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">iput</span><span class="token punctuation">(</span>ff<span class="token punctuation">.</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tfile_close: unsupported type.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="175-file_stat">1.7.5 <code>file_stat</code></h5>

<p>&#x51FD;&#x6570; <code>file_stat</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>stati</code> &#x8BFB;&#x53D6;&#x6587;&#x4EF6;&#x7684;&#x5143;&#x6570;&#x636E;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/file.c</span>

<span class="token comment">/*
 * Get metadata about file f.
 */</span>
<span class="token keyword">int</span>
<span class="token function">file_stat</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> f<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">stat</span><span class="token operator">*</span> st<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>type <span class="token operator">==</span> FD_INODE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ilock</span><span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">stati</span><span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">,</span> st<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">iunlock</span><span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="176-file_read">1.7.6 <code>file_read</code></h5>

<p>&#x51FD;&#x6570; <code>file_read</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x5BF9;&#x4E8E;&#x666E;&#x901A;&#x6587;&#x4EF6;&#xFF0C;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>readi</code> &#x4ECE;&#x6587;&#x4EF6;&#x4E2D;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#xFF08;&#x6682;&#x4E0D;&#x652F;&#x6301;&#x5176;&#x4ED6;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#xFF09;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/file.c</span>

<span class="token comment">/*
 * Read from file f.
 */</span>
<span class="token class-name">ssize_t</span>
<span class="token function">file_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> f<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> addr<span class="token punctuation">,</span> <span class="token class-name">ssize_t</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token operator">-&gt;</span>readable<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>type <span class="token operator">==</span> FD_INODE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ilock</span><span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">readi</span><span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> f<span class="token operator">-&gt;</span>off<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> f<span class="token operator">-&gt;</span>off <span class="token operator">+=</span> r<span class="token punctuation">;</span>
        <span class="token function">iunlock</span><span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tfile_read: unsupported type.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h5 class="mume-header" id="177-file_write">1.7.7 <code>file_write</code></h5>

<p>&#x51FD;&#x6570; <code>file_write</code> &#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x5BF9;&#x4E8E;&#x666E;&#x901A;&#x6587;&#x4EF6;&#xFF0C;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>writei</code> &#x5199;&#x5165;&#x6570;&#x636E;&#x5230;&#x6587;&#x4EF6;&#xFF08;&#x6682;&#x4E0D;&#x652F;&#x6301;&#x5176;&#x4ED6;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#xFF09;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/file.c</span>

<span class="token comment">/*
 * Write to file f.
 */</span>
<span class="token class-name">ssize_t</span>
<span class="token function">file_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> f<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> addr<span class="token punctuation">,</span> <span class="token class-name">ssize_t</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token operator">-&gt;</span>writable<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>type <span class="token operator">==</span> FD_INODE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Write a few blocks at a time to avoid exceeding the maximum log</span>
        <span class="token comment">// transaction size, including i-node, indirect block, allocation</span>
        <span class="token comment">// blocks, and 2 blocks of slop for non-aligned writes. This really</span>
        <span class="token comment">// belongs lower down, since writei() might be writing a device like the</span>
        <span class="token comment">// console.</span>
        <span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>MAXOPBLOCKS <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">512</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> n1 <span class="token operator">=</span> n <span class="token operator">-</span> i<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">&gt;</span> max<span class="token punctuation">)</span> n1 <span class="token operator">=</span> max<span class="token punctuation">;</span>

            <span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ilock</span><span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">writei</span><span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">,</span> addr <span class="token operator">+</span> i<span class="token punctuation">,</span> f<span class="token operator">-&gt;</span>off<span class="token punctuation">,</span> n1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> f<span class="token operator">-&gt;</span>off <span class="token operator">+=</span> r<span class="token punctuation">;</span>
            <span class="token function">iunlock</span><span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> n1<span class="token punctuation">)</span> <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tfile_write: partial data written.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i <span class="token operator">+=</span> r<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> i <span class="token operator">==</span> n <span class="token operator">?</span> n <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\tfile_write: unsupported type.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h3 class="mume-header" id="2-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8">2. &#x7CFB;&#x7EDF;&#x8C03;&#x7528;</h3>

<blockquote>
<p>&#x8BF7;&#x4FEE;&#x6539; <code>syscall.c</code> &#x4EE5;&#x53CA; <code>trapasm.S</code> &#x6765;&#x63A5;&#x4E0A; musl&#xFF0C;&#x6216;&#x8005;&#x4FEE;&#x6539; Makefile &#x5E76;&#x642C;&#x8FD0; xv6 &#x7684;&#x7B80;&#x6613; libc&#xFF0C;&#x4ECE;&#x800C;&#x5141;&#x8BB8;&#x7528;&#x6237;&#x6001;&#x7A0B;&#x5E8F;&#x901A;&#x8FC7;&#x8C03;&#x7528;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6765;&#x64CD;&#x4F5C;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x3002;</p>
</blockquote>
<p>&#x63A5;&#x4E0A; musl &#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x5BF9;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x7EC6;&#x8282;&#x8FDB;&#x884C;&#x4E86;&#x4E00;&#x4E9B;&#x4FEE;&#x6539;&#x3002;&#x4EE5;&#x4E0B;&#x6211;&#x4EEC;&#x5C06;&#x4EE5;&#x521D;&#x59CB;&#x5316;&#x7A0B;&#x5E8F; <code>user/initcode.S</code> &#x4E3A;&#x4F8B;&#xFF0C;&#x7B80;&#x5355;&#x68B3;&#x7406;&#x4E00;&#x4E0B;&#x7528;&#x6237;&#x7A0B;&#x5E8F;&#x8FDB;&#x884C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x5168;&#x8FC7;&#x7A0B;&#x3002;</p>
<h4 class="mume-header" id="21-initcodes">2.1 <code>initcode.S</code></h4>

<p>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x5F15;&#x5165;&#x4E86; musl &#x7684; <code>syscall.h</code>&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x4E86; libc &#x4E2D;&#x6240;&#x6709;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6240;&#x5BF9;&#x5E94;&#x7684; system call number &#x7684;&#x5B9A;&#x4E49;&#xFF0C;&#x4F8B;&#x5982;&#x7CFB;&#x7EDF;&#x8C03;&#x7528; <code>sys_exec</code> &#x5BF9;&#x5E94;&#x7684; system call number &#x5C31;&#x662F; <code>SYS_execve</code>&#xFF08;&#x5176;&#x503C;&#x4E3A; <code>221</code>&#xFF09;&#x3002;</p>
<p>&#x5BF9;&#x4E8E; AArch64 &#x67B6;&#x6784;&#x6765;&#x8BF4;&#xFF0C;&#x53D1;&#x8D77;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x65F6;&#xFF0C;&#x7528;&#x6237;&#x7A0B;&#x5E8F;&#x5148;&#x5C06;&#x53C2;&#x6570;&#x5730;&#x5740;&#x4FDD;&#x5B58;&#x5230;&#x901A;&#x7528;&#x5BC4;&#x5B58;&#x5668; X0 ~ X5 &#x91CC;&#xFF0C;&#x518D;&#x5C06;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x5BF9;&#x5E94;&#x7684; system call number &#x4FDD;&#x5B58;&#x5230;&#x5BC4;&#x5B58;&#x5668; X8 &#x91CC;&#xFF0C;&#x6700;&#x540E;&#x901A;&#x8FC7; <code>svc</code> &#x6307;&#x4EE4;&#x9677;&#x5165;&#x5185;&#x6838;&#x6001;&#x3002;</p>
<pre data-role="codeBlock" data-info="armasm {.line-numbers}" class="language-armasm line-numbers"><code>// user/initcode.S

# exec(init, argv)
start:
    ldr     x0, =init
    ldr     x1, =argv
    mov     x8, #SYS_execve
    svc     0x00

# char init[] = &quot;/init\0&quot;;
init:
    .string &quot;/init\0&quot;

# char *argv[] = { init, 0 };
.p2align 4
argv:
    .word init
    .word 0
    .word 0
    .word 0
</code><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h4 class="mume-header" id="22-trapasms">2.2 <code>trapasm.S</code></h4>

<p>&#x9677;&#x5165;&#x5185;&#x6838;&#x6001;&#x524D;&#xFF0C;&#x9700;&#x8981;&#x5148;&#x6784;&#x5EFA; trapframe &#x7ED3;&#x6784;&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x5728;&#x539F;&#x6709;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#xFF0C;&#x65B0;&#x589E;&#x4E86; musl &#x9700;&#x8981;&#x7528;&#x5230;&#x7684;&#x4E24;&#x4E2A;&#x5BC4;&#x5B58;&#x5668; Q0 &#x548C; TPIDR_EL0&#x3002;</p>
<pre data-role="codeBlock" data-info="armasm {.line-numbers}" class="language-armasm line-numbers"><code>// kern/trapasm.S

/* Save Q0 and TPIDR_EL0 to placate musl. */
str q0, [sp, #-16]!
mrs x4, tpidr_el0
stp xzr, x4, [sp, #-16]!
</code><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x5176;&#x4E2D;&#xFF0C;&#x96F6;&#x5BC4;&#x5B58;&#x5668; <code>xzr</code> &#x7528;&#x4E8E;&#x586B;&#x5145;&#x7A7A;&#x4F4D;&#xFF0C;&#x4EE5;&#x4FDD;&#x6301; 16 bytes &#x5BF9;&#x9F50;&#x3002;</p>
<p>&#x65B0;&#x7684; trapframe &#x7ED3;&#x6784;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// inc/trap.h</span>

<span class="token keyword">struct</span> <span class="token class-name">trapframe</span> <span class="token punctuation">{</span>
    <span class="token comment">// Additional registers used to support musl</span>
    <span class="token class-name">uint64_t</span> _padding<span class="token punctuation">;</span>  <span class="token comment">// for 16-byte aligned</span>
    <span class="token class-name">uint64_t</span> tpidr_el0<span class="token punctuation">;</span>
    __uint128_t q0<span class="token punctuation">;</span>

    <span class="token comment">// Special Registers</span>
    <span class="token class-name">uint64_t</span> sp_el0<span class="token punctuation">;</span>    <span class="token comment">// Stack Pointer</span>
    <span class="token class-name">uint64_t</span> spsr_el1<span class="token punctuation">;</span>  <span class="token comment">// Program Status Register</span>
    <span class="token class-name">uint64_t</span> elr_el1<span class="token punctuation">;</span>   <span class="token comment">// Exception Link Register</span>

    <span class="token comment">// General-Purpose Registers</span>
    <span class="token class-name">uint64_t</span> x0<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x1<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x2<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x3<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x4<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x5<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x6<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x7<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x8<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x9<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x10<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x11<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x12<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x13<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x14<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x15<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x16<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x17<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x18<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x19<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x20<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x21<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x22<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x23<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x24<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x25<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x26<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x27<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x28<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> x29<span class="token punctuation">;</span>  <span class="token comment">// Frame Pointer</span>
    <span class="token class-name">uint64_t</span> x30<span class="token punctuation">;</span>  <span class="token comment">// Procedure Link Register</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h4 class="mume-header" id="23-trapc">2.3 <code>trap.c</code></h4>

<p>&#x968F;&#x540E;&#x8DF3;&#x8F6C;&#x5230;&#x51FD;&#x6570; <code>trap</code> &#x5165;&#x53E3;&#x3002;&#x5728;&#x51FD;&#x6570; <code>trap</code> &#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x6839;&#x636E;&#x5BC4;&#x5B58;&#x5668; ESR (Exception Syndrome Register) &#x5224;&#x65AD;&#x5F53;&#x524D;&#x4E3A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x968F;&#x540E;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>syscall1</code>&#xFF0C;&#x4F20;&#x5165; trapframe&#xFF0C;&#x5E76;&#x5C06;&#x8FD4;&#x56DE;&#x503C;&#x4FDD;&#x5B58;&#x5728; trapframe &#x7684;&#x5BC4;&#x5B58;&#x5668; X0 &#x4E2D;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/trap.c</span>

<span class="token keyword">void</span>
<span class="token function">trap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">trapframe</span><span class="token operator">*</span> tf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ec <span class="token operator">=</span> <span class="token function">resr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> EC_SHIFT<span class="token punctuation">,</span> iss <span class="token operator">=</span> <span class="token function">resr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> ISS_MASK<span class="token punctuation">;</span>
    <span class="token function">lesr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Clear esr.</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>ec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> EC_UNKNOWN<span class="token operator">:</span> <span class="token function">interrupt</span><span class="token punctuation">(</span>tf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> EC_SVC64<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>iss<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* Jump to syscall to handle the system call from user process */</span>
            tf<span class="token operator">-&gt;</span>x0 <span class="token operator">=</span> <span class="token function">syscall1</span><span class="token punctuation">(</span>tf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">&quot;trap: unexpected svc iss 0x%x\n&quot;</span><span class="token punctuation">,</span> iss<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;\ttrap: unexpected irq.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h4 class="mume-header" id="24-syscallc">2.4 <code>syscall.c</code></h4>

<p>&#x6211;&#x4EEC;&#x6839;&#x636E;&#x4E4B;&#x524D;&#x4FDD;&#x5B58;&#x5728;&#x5BC4;&#x5B58;&#x5668; X8 &#x7684;&#x503C;&#xFF0C;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x5F53;&#x524D;&#x7684; system call number&#x3002;&#x968F;&#x540E;&#x5229;&#x7528;&#x51FD;&#x6570;&#x6307;&#x9488;&#x8868; <code>syscalls</code>&#xFF0C;&#x5373;&#x53EF;&#x8FDB;&#x884C;&#x76F8;&#x5E94;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/syscall.c</span>

<span class="token keyword">int</span>
<span class="token function">syscall1</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">trapframe</span><span class="token operator">*</span> tf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">proc</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">thisproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token operator">-&gt;</span>tf <span class="token operator">=</span> tf<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> sysno <span class="token operator">=</span> tf<span class="token operator">-&gt;</span>x8<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sysno <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> sysno <span class="token operator">&lt;</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>syscalls<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> syscalls<span class="token punctuation">[</span>sysno<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">&quot;syscall: syscall %d from proc %d\n&quot;</span><span class="token punctuation">,</span> sysno<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tf<span class="token operator">-&gt;</span>x0 <span class="token operator">=</span> syscalls<span class="token punctuation">[</span>sysno<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> tf<span class="token operator">-&gt;</span>x0<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">&quot;syscall: unknown syscall %d from proc %d\n&quot;</span><span class="token punctuation">,</span> sysno<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x51FD;&#x6570;&#x6307;&#x9488;&#x8868; <code>syscalls</code> &#x5305;&#x542B;&#x4E86;&#x6211;&#x4EEC;&#x76EE;&#x524D;&#x5DF2;&#x5B9E;&#x73B0;&#x7684;&#x6240;&#x6709;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF1A;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// inc/types.h</span>

<span class="token keyword">typedef</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></pre><pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// kern/syscall.c</span>

<span class="token keyword">static</span> func syscalls<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>SYS_set_tid_address<span class="token punctuation">]</span> <span class="token operator">=</span> sys_gettid<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_gettid<span class="token punctuation">]</span> <span class="token operator">=</span> sys_gettid<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_ioctl<span class="token punctuation">]</span> <span class="token operator">=</span> sys_ioctl<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_rt_sigprocmask<span class="token punctuation">]</span> <span class="token operator">=</span> sys_rt_sigprocmask<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_brk<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>func<span class="token punctuation">)</span>sys_brk<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_execve<span class="token punctuation">]</span> <span class="token operator">=</span> sys_exec<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_sched_yield<span class="token punctuation">]</span> <span class="token operator">=</span> sys_yield<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_clone<span class="token punctuation">]</span> <span class="token operator">=</span> sys_clone<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_wait4<span class="token punctuation">]</span> <span class="token operator">=</span> sys_wait4<span class="token punctuation">,</span>
    <span class="token comment">// FIXME: exit_group should kill every thread in the current thread group.</span>
    <span class="token punctuation">[</span>SYS_exit_group<span class="token punctuation">]</span> <span class="token operator">=</span> sys_exit<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_exit<span class="token punctuation">]</span> <span class="token operator">=</span> sys_exit<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_dup<span class="token punctuation">]</span> <span class="token operator">=</span> sys_dup<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_chdir<span class="token punctuation">]</span> <span class="token operator">=</span> sys_chdir<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_fstat<span class="token punctuation">]</span> <span class="token operator">=</span> sys_fstat<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_newfstatat<span class="token punctuation">]</span> <span class="token operator">=</span> sys_fstatat<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_mkdirat<span class="token punctuation">]</span> <span class="token operator">=</span> sys_mkdirat<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_mknodat<span class="token punctuation">]</span> <span class="token operator">=</span> sys_mknodat<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_openat<span class="token punctuation">]</span> <span class="token operator">=</span> sys_openat<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_writev<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>func<span class="token punctuation">)</span>sys_writev<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_read<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>func<span class="token punctuation">)</span>sys_read<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>SYS_close<span class="token punctuation">]</span> <span class="token operator">=</span> sys_close<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x7531;&#x4E8E;&#x65F6;&#x95F4;&#x6709;&#x9650;&#xFF0C;&#x8FD9;&#x4E9B;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x529F;&#x80FD;&#x548C;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x7EC6;&#x8BB2;&#x4E86;&#x3002;&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x7684;&#x4F4D;&#x7F6E;&#x53EF;&#x4EE5;&#x53C2;&#x89C1; <code>syscall1.h</code> &#x7684;&#x6CE8;&#x91CA;&#x3002;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// inc/syscall1.h</span>

<span class="token comment">// kern/syscall1.c</span>

<span class="token keyword">int</span> <span class="token function">sys_gettid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_ioctl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_rt_sigprocmask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// kern/sysproc.c</span>

<span class="token keyword">int</span> <span class="token function">sys_exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">size_t</span> <span class="token function">sys_brk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_wait4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// kern/sysfile.c</span>

<span class="token keyword">int</span> <span class="token function">sys_dup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ssize_t</span> <span class="token function">sys_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ssize_t</span> <span class="token function">sys_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ssize_t</span> <span class="token function">sys_writev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_fstat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_fstatat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_openat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_mkdirat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_mknodat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_chdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>&#x81F3;&#x6B64;&#xFF0C;&#x7528;&#x6237;&#x7A0B;&#x5E8F;&#x5C31;&#x5B8C;&#x6210;&#x4E86;&#x4E00;&#x6B21;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x3002;</p>
<h3 class="mume-header" id="3-shell">3. Shell</h3>

<blockquote>
<p>&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x628A; xv6 &#x7684; shell &#x642C;&#x8FD0;&#x5230;&#x4E86; <code>user/src/sh</code> &#x76EE;&#x5F55;&#x4E0B;&#xFF0C;&#x4F46;&#x9700;&#x8981;&#x5B9E;&#x73B0; brk &#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6765;&#x4F7F;&#x7528; malloc&#xFF0C;&#x4F60;&#x4E5F;&#x53EF;&#x4EE5;&#x81EA;&#x884C;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684; shell&#x3002;&#x8BF7;&#x5728; <code>user/src/cat</code> &#x4E2D;&#x5B9E;&#x73B0; cat &#x547D;&#x4EE4;&#x5E76;&#x5728;&#x4F60;&#x7684; shell &#x4E2D;&#x6267;&#x884C;&#x3002;</p>
</blockquote>
<h4 class="mume-header" id="31-cat">3.1 <code>cat</code></h4>

<p>&#x6211;&#x4EEC;&#x5F15;&#x7528;&#x4E86; 3 &#x4E2A;&#x5934;&#x6587;&#x4EF6;&#xFF0C;&#x5206;&#x522B;&#x7528;&#x4E8E;&#xFF1A;</p>
<ul>
<li><code>fcntl.h</code>&#xFF1A;&#x6253;&#x5F00;&#x548C;&#x5173;&#x95ED;&#x6587;&#x4EF6;&#xFF0C;&#x5BF9;&#x5E94;&#x51FD;&#x6570; <code>open</code> &#x548C; <code>close</code></li>
<li><code>stdio.h</code>&#xFF1A;&#x8F93;&#x51FA;&#x6587;&#x672C;&#x5230;&#x7EC8;&#x7AEF;&#xFF0C;&#x5BF9;&#x5E94;&#x51FD;&#x6570; <code>printf</code></li>
<li><code>unistd.h</code>&#xFF1A;&#x5404;&#x79CD;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x5305;&#x62EC;&#x51FD;&#x6570; <code>read</code>, <code>write</code>, <code>_exit</code></li>
</ul>
<p><code>cat</code> &#x547D;&#x4EE4;&#x7684;&#x5B9E;&#x8D28;&#x5C31;&#x662F;&#x4ECE;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#xFF0C;&#x7136;&#x540E;&#x5199;&#x5165;&#x5230;&#x53E6;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#xFF08;&#x9ED8;&#x8BA4;&#x4E3A;&#x7EC8;&#x7AEF;&#xFF09;&#x3002;&#x81F3;&#x4E8E;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#x662F;&#x7BA1;&#x9053;&#x3001;&#x7EC8;&#x7AEF;&#x8FD8;&#x662F;&#x666E;&#x901A;&#x6587;&#x4EF6;&#xFF0C;&#x6211;&#x4EEC;&#x5E76;&#x4E0D;&#x5173;&#x5FC3;&#xFF0C;&#x56E0;&#x4E3A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x5E95;&#x5C42;&#x5DF2;&#x7ECF;&#x9488;&#x5BF9;&#x4E0D;&#x540C;&#x7684;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#x8FDB;&#x884C;&#x4E86;&#x76F8;&#x5E94;&#x7684;&#x5904;&#x7406;&#x3002;<code>cat</code> &#x547D;&#x4EE4;&#x7684;&#x5B8C;&#x6574;&#x5B9E;&#x73B0;&#x5982;&#x4E0B; <sup class="footnote-ref"><a href="#fn2" id="fnref2:1">[2:1]</a></sup>&#xFF1A;</p>
<pre data-role="codeBlock" data-info="c {.line-numbers}" class="language-c line-numbers"><span class="token comment">// user/src/cat/main.c</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">void</span>
<span class="token function">cat</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">!=</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;cat: write error.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;cat: read error.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span>
<span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;cat: cannot open %s.\n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">cat</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><h2 class="mume-header" id="%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C">&#x8FD0;&#x884C;&#x7ED3;&#x679C;</h2>

<p>&#x9057;&#x61BE;&#x7684;&#x662F;&#xFF0C;&#x7531;&#x4E8E;&#x65F6;&#x95F4;&#x6709;&#x9650;&#xFF0C;&#x4EE3;&#x7801;&#x867D;&#x7136;&#x5DF2;&#x5168;&#x90E8;&#x5B8C;&#x6210;&#xFF08;&#x5305;&#x62EC;&#x6240;&#x6709;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x4EE5;&#x53CA;&#x51FD;&#x6570; <code>fork</code>, <code>wait</code>, <code>execve</code> &#x7B49;&#xFF09;&#xFF0C;&#x4F46;&#x5C1A;&#x672A;&#x8C03;&#x901A;&#x3002;&#x76EE;&#x524D;&#x7CFB;&#x7EDF;&#x53EF;&#x4EE5;&#x6210;&#x529F;&#x8FDB;&#x884C;&#x5230;&#x521D;&#x59CB;&#x5316;&#x7A0B;&#x5E8F; <code>initcode.S</code> &#x5B8C;&#x6210;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x4F46;&#x6682;&#x65F6;&#x8FD8;&#x4E0D;&#x80FD;&#x542F;&#x52A8; shell&#xFF0C;&#x6545;&#x969C;&#x539F;&#x56E0;&#x4ECD;&#x5728;&#x6392;&#x67E5;&#x4E2D;&#x3002;</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash"><span class="token operator">&gt;</span> <span class="token function">make</span>
<span class="token operator">&gt;</span> <span class="token function">make</span> qemu
</pre><pre data-role="codeBlock" data-info="text" class="language-text"><code>console_init: success.
main: [CPU 3] init started.
alloc_init: success.
proc_init: success.
irq_init: success.
timer_init: success at CPU 3.
file_init: success.
binit: success.
- mbox write: 0x7ccc8
- mbox read: 0x7ccc8
- clock rate: 50000000
- SD base clock rate from mailbox: 50000000
- Reset the card.
- Divisor selected = 104, shift count = 6
- EMMC: Set clock, status 0x1ff0000 CONTROL1: 0xe6807
- Send IX_GO_IDLE_STATE command.
- Send command response: 0
- EMMC: Sending ACMD41 SEND_OP_COND status 1ff0000
- Divisor selected = 2, shift count = 0
- EMMC: Set clock, status 0x1ff0000 CONTROL1: 0xe0207
- EMMC: SD Card Type 2 SC 128Mb UHS-I 0 mfr 170 &apos;XY:QEMU!&apos; r0.1 2/2006, #deadbeef RCA 4567
sd_init: Partition 1: 00 20 21 00 0c 49 01 08 00 08 00 00 00 00 02 00 
- Status: 0
- CHS address of first absolute sector: head=32, sector=33, cylinder=0
- Partition type: 12
- CHS address of last absolute sector: head=73, sector=1, cylinder=8
- LBA of first absolute sector: 0x800
- Number of sectors: 131072
sd_init: Partition 2: 00 49 02 08 83 51 01 10 00 08 02 00 00 f8 01 00 
- Status: 0
- CHS address of first absolute sector: head=73, sector=2, cylinder=8
- Partition type: 131
- CHS address of last absolute sector: head=81, sector=1, cylinder=16
- LBA of first absolute sector: 0x20800
- Number of sectors: 129024
sd_init: Partition 3: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
- Status: 0
- CHS address of first absolute sector: head=0, sector=0, cylinder=0
- Partition type: 0
- CHS address of last absolute sector: head=0, sector=0, cylinder=0
- LBA of first absolute sector: 0x0
- Number of sectors: 0
sd_init: Partition 4: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
- Status: 0
- CHS address of first absolute sector: head=0, sector=0, cylinder=0
- Partition type: 0
- CHS address of last absolute sector: head=0, sector=0, cylinder=0
- LBA of first absolute sector: 0x0
- Number of sectors: 0
sd_init: Boot signature: 55 aa
sd_init: success.
proc_alloc: proc 1 success.
user_init: proc 1 (initproc) success.
main: [CPU 3] init success.
main: [CPU 0] init started.
timer_init: success at CPU 0.
main: [CPU 2] init started.
timer_init: success at CPU 2.
main: [CPU 1] init started.
main: [CPU 0] init success.
main: [CPU 2] init success.
timer_init: success at CPU 1.
bget: dev 1 blockno 133121
main: [CPU 1] init success.
super block: size 1000 nblocks 941 ninodes 200 nlog 30 logstart 2 inodestart 32 bmapstart 58
iinit: success.
bget: dev 1 blockno 133121
bget: dev 1 blockno 133122
bget: dev 1 blockno 133122
initlog: success.
syscall: syscall 221 from proc 1
sys_exec: exec &apos;&apos; uargv 0
sys_exec: failed to fetch argument.
</code></pre><h2 class="mume-header" id="%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83">&#x6D4B;&#x8BD5;&#x73AF;&#x5883;</h2>

<ul>
<li>OS: Ubuntu 18.04.5 LTS (5.4.72-microsoft-standard-WSL2)</li>
<li>Compiler: gcc version 8.4.0 (Ubuntu/Linaro 8.4.0-1ubuntu1~18.04)
<ul>
<li>Target: aarch64-linux-gnu</li>
</ul>
</li>
<li>Debugger: GNU gdb 8.2 (Ubuntu 8.2-0ubuntu1~18.04)
<ul>
<li>Target: aarch64-linux-gnu</li>
</ul>
</li>
<li>Emulator: QEMU emulator version 5.0.50</li>
<li>Using GNU Make 4.1</li>
</ul>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://pdos.csail.mit.edu/6.828/2020/xv6/book-riscv-rev1.pdf">xv6: a simple, Unix-like teaching operating system - MIT</a> <a href="#fnref1" class="footnote-backref">&#x21A9;&#xFE0E;</a> <a href="#fnref1:1" class="footnote-backref">&#x21A9;&#xFE0E;</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a href="https://github.com/mit-pdos/xv6-public">mit-pdos/xv6-public: xv6 OS - GitHub</a> <a href="#fnref2" class="footnote-backref">&#x21A9;&#xFE0E;</a> <a href="#fnref2:1" class="footnote-backref">&#x21A9;&#xFE0E;</a></p>
</li>
</ol>
</section>

      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>